<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>seb365 pro</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-primary: #ffffff; --bg-secondary: #f8f9fa; --bg-tertiary: #f1f3f4;
      --border-color: #e0e0e0; --text-primary: #202124; --text-secondary: #5f6368;
      --brand-primary: #ff6f00; --brand-secondary: #f57c00; --accent-red: #d93025;
      --accent-green: #1e8e3e; --shadow-color: rgba(0, 0, 0, 0.08);
      --dark-bg-primary: #202124; --dark-bg-secondary: #303134; --dark-bg-tertiary: #3c4043;
      --dark-border-color: #424548; --dark-text-primary: #e8eaed; --dark-text-secondary: #9aa0a6;
      --dark-brand-primary: #ff8f00; --dark-brand-secondary: #ffa000; --dark-accent-red: #f28b82;
      --dark-accent-green: #81c995; --dark-shadow-color: rgba(0, 0, 0, 0.3);
      --grad-yellow: #ffc107; --grad-orange: #ff6f00; --grad-red: #ff3d00;
    }
    body[data-theme="dark"] {
      --bg-primary: var(--dark-bg-primary); --bg-secondary: var(--dark-bg-secondary);
      --bg-tertiary: var(--dark-bg-tertiary); --border-color: var(--dark-border-color);
      --text-primary: var(--dark-text-primary); --text-secondary: var(--dark-text-secondary);
      --brand-primary: var(--dark-brand-primary); --brand-secondary: var(--dark-brand-secondary);
      --accent-red: var(--dark-accent-red); --accent-green: var(--dark-accent-green);
      --shadow-color: var(--dark-shadow-color);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; overflow-x: hidden; }
    body {
      margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-primary);
      color: var(--text-primary); transition: background-color 0.2s, color 0.2s;
    }
    main { display: flex; min-height: calc(100vh - 60px); }
    #content { flex: 1; padding: 24px; padding-bottom: 80px; }
    .hidden { display: none !important; }

    /* --- Animación de Inicio --- */
    #splash-screen {
      position: fixed; inset: 0; background: #0f1115; z-index: 10000;
      display: flex; align-items: center; justify-content: center; flex-direction: column;
      transition: opacity 0.5s ease-out;
    }
    #splash-screen.hidden { opacity: 0; pointer-events: none; }
    .splash-title {
      font-size: clamp(2rem, 10vw, 3.5rem); font-weight: 700;
      background: linear-gradient(90deg, var(--grad-yellow), var(--grad-orange), var(--grad-red));
      background-size: 200% auto; -webkit-background-clip: text; background-clip: text; color: transparent;
      white-space: nowrap; overflow: hidden; border-right: .15em solid var(--brand-primary);
      animation: typing 2.2s steps(11, end), blink-caret .75s step-end infinite, color-pan 3s linear infinite;
      margin-top: 24px;
    }
    @keyframes typing { from { width: 0 } to { width: 100% } }
    @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: var(--brand-primary); } }
    @keyframes color-pan { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    .logo-cube-container{ width: clamp(120px, 22vw, 180px); aspect-ratio: 1/1; display: grid; place-items: center; filter: drop-shadow(0 10px 30px rgba(255, 111, 0, .18)); transform: translateZ(0); }
    .logo-cube{ width: 100%; height: 100%; transform: rotate(-2deg); }
    .edge{ stroke: url(#brandStroke); stroke-width: 3.2; stroke-linecap: round; fill: none; stroke-dasharray: 100; stroke-dashoffset: 100; filter: drop-shadow(0 0 6px rgba(255,111,0,.35)); animation: draw 0.85s ease forwards; animation-delay: calc(var(--i) * 0.12s); }
    @keyframes draw { to { stroke-dashoffset: 0; } }
    .face{ fill: url(#brandGradient); fill-opacity: 0; stroke: none; animation: faceIn 0.9s ease forwards; animation-delay: 1.8s; }
    @keyframes faceIn { to { fill-opacity: 1; } }
    .shine{ opacity: 0; animation: shineIn 2.2s ease-in-out 1.9s forwards; mix-blend-mode: screen; }
    @keyframes shineIn { 10% {opacity:.0} 20%{opacity:.25} 70%{opacity:.12} 100%{opacity:0} }

    /* --- Header y Logo --- */
    header {
      display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
      height: 60px; border-bottom: 1px solid var(--border-color); background-color: var(--bg-secondary);
    }
    .header-logo {
      margin: 0; font-size: 22px; font-weight: 700;
      display: flex; align-items: center; gap: 10px;
    }
    .header-logo-icon { width: 28px; height: 28px; }
    .header-logo-text {
      background: linear-gradient(90deg, var(--grad-yellow), var(--grad-orange), var(--grad-red));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .header-logo-pro { font-weight: 900; }
    body[data-theme="dark"] .header-logo-text { background: none; -webkit-background-clip: initial; background-clip: initial; }
    body[data-theme="dark"] .header-logo-seb { color: var(--dark-text-primary); }
    body[data-theme="dark"] .header-logo-pro {
      background: linear-gradient(90deg, var(--grad-yellow), var(--grad-orange), var(--grad-red));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }

    .user-info { display: flex; align-items: center; gap: 12px; font-size: 14px; }
    #main-nav {
      width: 250px; padding: 16px 8px; border-right: 1px solid var(--border-color);
      background: var(--bg-secondary); transition: left 0.3s ease-in-out;
    }
    #main-nav .nav-link {
      display: flex; gap: 16px; align-items: center; color: var(--text-secondary); padding: 10px 16px;
      border-radius: 8px; text-decoration: none; margin-bottom: 4px; font-weight: 500;
      transition: background-color 0.2s, color 0.2s;
    }
    #main-nav .nav-link:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
    #main-nav .nav-link.active {
      background-color: rgba(255, 111, 0, 0.1); color: var(--brand-primary); font-weight: 700;
    }
    .nav-link svg { width: 20px; height: 20px; }
    .card {
      background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px;
      padding: 20px; box-shadow: 0 2px 4px var(--shadow-color);
    }
    .content-view h2, .card h2, .auth-box h2 { margin: 0 0 24px 0; font-size: 24px; font-weight: 500; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
    input, select, button { font: inherit; outline-color: var(--brand-primary); }
    input, select {
      width: 100%; padding: 12px 14px; border-radius: 8px; border: 1px solid var(--border-color);
      background-color: var(--bg-primary); color: var(--text-primary); transition: border-color 0.2s;
    }
    .password-wrapper { position: relative; }
    .password-wrapper input { padding-right: 44px; }
    .password-toggle-btn {
      position: absolute; right: 4px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; padding: 8px; color: var(--text-secondary);
      display: flex; align-items: center; justify-content: center;
    }
    .password-toggle-btn:hover { color: var(--text-primary); }
    .password-toggle-btn svg { width: 20px; height: 20px; }
    input:focus, select:focus { border-color: var(--brand-primary); }
    button {
      background: linear-gradient(45deg, var(--grad-red), var(--grad-orange), var(--grad-yellow)); background-size: 200% auto;
      border: none; color: #fff; padding: 12px 18px; border-radius: 8px; cursor: pointer;
      font-weight: 500; transition: background-position 0.4s ease, background-color 0.3s ease;
    }
    button:hover { background-position: right center; }
    button[disabled] { opacity: .6; cursor: not-allowed; background-position: left center !important; }
    .button-secondary {
      background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color);
    }
    .button-secondary:hover { background: var(--border-color); }
    label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 14px; text-align: left; }
    .table-wrapper { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; border-spacing: 0; }
    thead th {
      font-weight: 500; color: var(--text-secondary); text-align: left; padding: 12px 16px;
      background-color: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);
    }
    tbody td { background: var(--bg-secondary); padding: 12px 16px; border-bottom: 1px solid var(--border-color); }
    tbody tr:last-child td { border-bottom: none; }
    .actions { display: flex; gap: 8px; }
    .actions button { padding: 6px 10px; font-size: 14px; }
    #toast-container { position: fixed; right: 24px; bottom: 24px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
    .toast {
      padding: 14px 18px; border-radius: 8px; background-color: var(--bg-tertiary); border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px var(--shadow-color); color: var(--text-primary);
    }
    .toast.success { border-left: 4px solid var(--accent-green); }
    .toast.error { border-left: 4px solid var(--accent-red); }
    .amount-positive { color: var(--accent-green); } .amount-negative { color: var(--accent-red); }
    #auth-container { display: flex; align-items: center; justify-content: center; padding: 24px; min-height: 100vh; }
    .auth-box { max-width: 420px; width: 100%; text-align: center; }
    .auth-form-fields { display: flex; flex-direction: column; gap: 16px; margin-bottom: 16px; }
    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
        display: flex; align-items: center; justify-content: center; z-index: 1000;
        backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .modal.visible { opacity: 1; pointer-events: all; }
    .modal-content {
        background: var(--bg-primary); padding: 32px; border-radius: 12px;
        width: 90%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        transform: scale(0.95); transition: transform 0.3s ease;
    }
    .modal.visible .modal-content { transform: scale(1); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-header h3 { margin: 0; font-size: 22px; }
    .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); line-height: 1; }
    .modal-form-body { display: flex; flex-direction: column; gap: 20px; }
    #fichas-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 16px; margin-bottom: 24px;
    }
    .ficha-card {
        background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px;
        padding: 16px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
    }
    .ficha-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px var(--shadow-color); }
    .ficha-card h4 { margin: 0 0 8px 0; font-size: 16px; color: var(--text-primary); text-transform: uppercase; }
    .ficha-card-stock { font-size: 20px; font-weight: 700; color: var(--brand-primary); }
    .ficha-card-stock span { font-size: 12px; font-weight: 400; color: var(--text-secondary); }
    .active-shifts-list { display: flex; flex-direction: column; gap: 12px; }
    .active-shift-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color);
    }
    .active-shift-item-info { display: flex; flex-direction: column; }
    .active-shift-item-info strong { font-size: 18px; color: var(--text-primary); }
    .active-shift-item-info span { font-size: 14px; color: var(--text-secondary); }
    .active-shift-item-actions { display: flex; gap: 10px; }
    #mobile-footer {
      display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
      background-color: var(--bg-secondary); border-top: 1px solid var(--border-color);
      box-shadow: 0 -2px 10px var(--shadow-color); z-index: 50;
    }
    #mobile-footer-nav { display: flex; justify-content: space-around; align-items: center; height: 100%; }
    .mobile-nav-link {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-decoration: none; color: var(--text-secondary); flex-grow: 1;
      height: 100%; transition: color 0.2s;
    }
    .mobile-nav-link svg { width: 24px; height: 24px; margin-bottom: 4px; }
    .mobile-nav-link span { font-size: 10px; font-weight: 500; }
    .mobile-nav-link.active { color: var(--brand-primary); }

    @media (max-width: 768px) {
      #main-nav { position: fixed; left: -270px; top: 60px; height: calc(100vh - 60px); z-index: 80; box-shadow: 4px 0 15px rgba(0,0,0,.1); }
      #main-nav.open { left: 0; }
      #content { padding: 16px; padding-bottom: 80px; }
      #menu-toggle { display: block !important; }
      #mobile-footer { display: block; }
      #logout-btn span { display: none; }
      #logout-btn { padding: 8px; }
    }
    @media (max-width: 640px) {
      header { padding: 0 16px; }
      .form-grid { grid-template-columns: 1fr; }
      .active-shift-item { flex-direction: column; align-items: flex-start; gap: 12px; }
      table { font-size: 14px; }
      thead th, tbody td { padding: 12px 8px; }
      .actions { flex-wrap: wrap; gap: 6px; }
      .actions button { padding: 5px 8px; font-size: 13px; }
    }
  </style>
</head>
<body>

  <div id="splash-screen">
    <div class="logo-cube-container" aria-label="Animación de cubo">
      <svg class="logo-cube" viewBox="0 0 120 120" role="img" aria-hidden="true">
        <defs>
          <linearGradient id="brandGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%"  stop-color="var(--grad-yellow)"/>
            <stop offset="55%" stop-color="var(--grad-orange)"/>
            <stop offset="100%" stop-color="var(--grad-red)"/>
          </linearGradient>
          <linearGradient id="brandStroke" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="var(--grad-yellow)"/>
            <stop offset="50%" stop-color="var(--grad-orange)"/>
            <stop offset="100%" stop-color="var(--grad-red)"/>
          </linearGradient>
          <linearGradient id="shineGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="rgba(255,255,255,0)"/>
            <stop offset="40%" stop-color="rgba(255,255,255,.35)"/>
            <stop offset="60%" stop-color="rgba(255,255,255,.0)"/>
          </linearGradient>
          <clipPath id="cubeClip"><path d="M60 10 L100 30 L100 70 L60 90 L20 70 L20 30 Z"/></clipPath>
        </defs>
        <polygon class="face" points="60,10 100,30 60,50 20,30"/><polygon class="face" points="100,30 100,70 60,90 60,50"/><polygon class="face" points="20,30 60,50 60,90 20,70"/>
        <path class="edge" style="--i:0"  d="M60 10 L100 30" pathLength="100"/><path class="edge" style="--i:1"  d="M100 30 L60 50" pathLength="100"/><path class="edge" style="--i:2"  d="M60 50 L20 30" pathLength="100"/><path class="edge" style="--i:3"  d="M20 30 L60 10" pathLength="100"/><path class="edge" style="--i:4"  d="M100 30 L100 70" pathLength="100"/><path class="edge" style="--i:5"  d="M20 30  L20 70"  pathLength="100"/><path class="edge" style="--i:6"  d="M100 70 L60 90" pathLength="100"/><path class="edge" style="--i:7"  d="M60 90  L20 70" pathLength="100"/><path class="edge" style="--i:8"  d="M60 50 L60 90" pathLength="100"/><path class="edge" style="--i:9"  d="M60 10 L60 50" pathLength="100"/><path class="edge" style="--i:10" d="M20 70 L60 50" pathLength="100"/><path class="edge" style="--i:11" d="M60 50 L100 70" pathLength="100"/>
        <g class="shine" clip-path="url(#cubeClip)"><rect x="-120" y="0" width="240" height="120" fill="url(#shineGrad)"><animate attributeName="x" from="-120" to="120" dur="1.8s" fill="freeze" begin="1.95s" /></rect></g>
      </svg>
    </div>
    <h1 class="splash-title">seb365 pro</h1>
  </div>

  <div id="toast-container"></div>
  <div id="auth-container"></div>

  <div id="app-container" class="hidden">
    <header>
      <button id="menu-toggle" title="Menú" class="button-secondary" style="padding: 8px 10px; display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
      </button>
      <h1 class="header-logo">
        <svg class="header-logo-icon" viewBox="0 0 120 120">
          <defs><linearGradient id="headerLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="var(--grad-yellow)"/><stop offset="55%" stop-color="var(--grad-orange)"/><stop offset="100%" stop-color="var(--grad-red)"/></linearGradient></defs>
          <g fill="url(#headerLogoGradient)">
            <polygon points="60,10 100,30 60,50 20,30"/><polygon points="100,30 100,70 60,90 60,50"/><polygon points="20,30 60,50 60,90 20,70"/>
          </g>
        </svg>
        <span class="header-logo-text"><span class="header-logo-seb">seb365</span> <span class="header-logo-pro">pro</span></span>
      </h1>
      <div class="user-info">
        <button id="theme-toggle" title="Alternar tema" class="button-secondary" style="padding: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </button>
        <button id="profile-btn" title="Mi Perfil" class="button-secondary" style="padding: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </button>
        <button id="logout-btn" class="button-secondary" style="display:flex; align-items:center; gap: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            <span>Salir</span>
        </button>
      </div>
    </header>
    <main>
      <nav id="main-nav">
        <a href="#" class="nav-link" data-view="dashboard-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg><span>Reportes</span></a>
        <a href="#" class="nav-link" data-view="shifts-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>Turnos y Ventas</span></a>
        <a href="#" class="nav-link" data-view="inventory-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="m3.27 6.96 8.73 5.05 8.73-5.05"/><path d="m12 22.08V12"/></svg><span>Inventario</span></a>
        <a href="#" class="nav-link" data-view="cashflow-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg><span>Flujo de Caja</span></a>
        <a href="#" class="nav-link" data-view="products-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><span>Productos y Fichas</span></a>
        <a href="#" class="nav-link" data-view="providers-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg><span>Proveedores</span></a>
        <a href="#" class="nav-link admin-only" data-view="workers-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Trabajadores</span></a>
        <a href="#" class="nav-link hidden" data-view="profile-view"></a>
      </nav>
      <div id="content"></div>
    </main>
    <footer id="mobile-footer">
        <div id="mobile-footer-nav">
            <a href="#" class="mobile-nav-link" data-view="shifts-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>Turnos</span></a>
            <a href="#" class="mobile-nav-link" data-view="inventory-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="m3.27 6.96 8.73 5.05 8.73-5.05"/><path d="m12 22.08V12"/></svg><span>Inventario</span></a>
            <a href="#" class="mobile-nav-link" data-view="cashflow-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg><span>Caja</span></a>
            <a href="#" class="mobile-nav-link" data-view="products-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><span>Productos</span></a>
            <a href="#" class="mobile-nav-link" data-view="providers-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg><span>Proveedores</span></a>
        </div>
    </footer>
  </div>

  <div id="loan-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>Registrar Préstamo</h3><button type="button" class="modal-close-btn">&times;</button></div>
        <form id="loan-form">
            <div class="modal-form-body">
                <input id="loan-description" placeholder="Descripción" required>
                <input id="loan-value" type="number" step="any" min="1" placeholder="Valor" required>
                <button type="submit">Añadir Préstamo</button>
            </div>
        </form>
    </div>
  </div>
 
  <div id="ficha-sale-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="ficha-sale-modal-title">Vender Ficha</h3>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <form id="ficha-sale-form">
            <div class="modal-form-body">
                <input type="hidden" id="ficha-sale-product-id">
                <p>Stock disponible: <strong id="ficha-sale-stock"></strong></p>
                <div>
                    <label for="ficha-sale-quantity">Cantidad a vender:</label>
                    <input id="ficha-sale-quantity" type="number" min="1" required>
                </div>
                <button type="submit">Confirmar Venta</button>
            </div>
        </form>
    </div>
  </div>

  <div id="desglose-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="desglose-modal-title">Desglose del Turno</h3>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div id="desglose-modal-body" class="table-wrapper" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, collectionGroup, doc, setDoc, addDoc, getDoc, onSnapshot, query, where, orderBy, serverTimestamp, writeBatch, runTransaction, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Inicialización de Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyDm2g7JwRNwF9Xgktj9ATPkJM8qnss8eNg",
        authDomain: "seb360-pro.firebaseapp.com",
        projectId: "seb360-pro",
        storageBucket: "seb360-pro.appspot.com",
        messagingSenderId: "750401346580",
        appId: "1:750401346580:web:a682fd6ae09292ff589b01"
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);

    // --- Helpers y Estado Global ---
    const tenantId = () => auth.currentUser?.uid;
    const TCOL = (...segs) => collection(db, "tenants", tenantId(), ...segs);
    const TDOC = (...segs) => doc(db, "tenants", tenantId(), ...segs);
    const stockRef = (productId, place) => TDOC("inventory", productId, "stock", place);

    let colref = {};
    function buildColRef() {
      if (!tenantId()) return;
      colref = {
        users: collection(db, "users"),
        products: TCOL("products"),
        providers: TCOL("providers"),
        workers: TCOL("workers"),
        cashflow: TCOL("cashflow_entries"),
        shifts: TCOL("shifts"),
        purchases: TCOL("purchases")
      };
    }

    let appState = {
      user: null, userData: null, role: null, unsub: [],
      products: [], providers: [], workers: [],
      inventory: {}, cashflow: [],
      activeShifts: [], selectedShiftId: null
    };
    let registrationData = {}, shiftSubListeners = {}, stockUnsubscribers = {};

    // --- Funciones de Utilidad ---
    const showToast = (msg, type = "success") => {
      const c = document.getElementById("toast-container");
      const t = document.createElement("div");
      t.className = `toast ${type}`;
      t.textContent = msg;
      c.appendChild(t);
      setTimeout(() => t.remove(), 3200);
    };

    const COP = (v) => new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", maximumFractionDigits: 0 }).format(v);
    const fmtDate = (ts) => ts?.toDate().toLocaleString("es-CO", { hour12: true, day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'}) ?? "—";

    const toUnidades = (qty, unit, prod) => {
        if (!prod) return qty;
        if (unit === "cajas") return qty * (prod.unidadesPorCaja || 1);
        if (unit === "canastas") return qty * (prod.unidadesPorCanasta || 1);
        return qty;
    };

    let raf = null;
    const scheduleRender = (forceId = null) => {
      if (raf) return;
      raf = requestAnimationFrame(() => {
        const activeId = forceId || (document.querySelector(".nav-link.active")?.dataset.view) || "dashboard-view";
        renderView(activeId);
        document.querySelectorAll('.mobile-nav-link').forEach(link => {
            link.classList.toggle('active', link.dataset.view === activeId);
        });
        raf = null;
      });
    };

    // --- Manejadores de Eventos Principales ---
    const mainNav = document.getElementById("main-nav");
    const mobileFooterNav = document.getElementById("mobile-footer-nav");
    
    function handleNavClick(e) {
      const link = e.target.closest(".nav-link, .mobile-nav-link");
      if (!link) return;
      e.preventDefault();
      mainNav.classList.remove("open");
      const viewId = link.dataset.view;
      document.querySelectorAll(".nav-link, .mobile-nav-link").forEach(n => {
        n.classList.toggle('active', n.dataset.view === viewId);
      });
      appState.selectedShiftId = null;
      scheduleRender(viewId);
    }

    mainNav.addEventListener("click", handleNavClick);
    mobileFooterNav.addEventListener("click", handleNavClick);
    document.getElementById("menu-toggle").addEventListener("click", () => mainNav.classList.toggle("open"));
    document.getElementById("profile-btn").addEventListener("click", () => document.querySelector('.nav-link[data-view="profile-view"]').click());
    document.getElementById("logout-btn").addEventListener("click", () => signOut(auth));

    // --- Lógica del Tema (Claro/Oscuro) ---
    const themeToggleBtn = document.getElementById('theme-toggle');
    const updateThemeToggleIcon = (theme) => {
      const icon = themeToggleBtn.querySelector('svg');
      icon.innerHTML = theme === 'dark'
        ? `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>`
        : `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`;
    };
    themeToggleBtn.addEventListener('click', () => {
      const newTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeToggleIcon(newTheme);
    });
    const savedTheme = localStorage.getItem('theme');
    const initialTheme = savedTheme || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    document.body.setAttribute('data-theme', initialTheme);
    updateThemeToggleIcon(initialTheme);

    // --- Flujo de Autenticación ---
    const authContainer = document.getElementById("auth-container");
    const ICONS = {
        eye: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
        eyeOff: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" y1="2" x2="22" y2="22"></line></svg>`
    };

    function renderAuthUI() {
        authContainer.innerHTML = `
        <div class="auth-box card">
            <h1 class="header-logo" style="justify-content: center; font-size: 28px; margin-bottom: 8px;">
              <svg class="header-logo-icon" viewBox="0 0 120 120" style="width: 36px; height: 36px;">
                <defs><linearGradient id="authLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="var(--grad-yellow)"/><stop offset="55%" stop-color="var(--grad-orange)"/><stop offset="100%" stop-color="var(--grad-red)"/></linearGradient></defs>
                <g fill="url(#authLogoGradient)"><polygon points="60,10 100,30 60,50 20,30"/><polygon points="100,30 100,70 60,90 60,50"/><polygon points="20,30 60,50 60,90 20,70"/></g>
              </svg>
              <span class="header-logo-text"><span class="header-logo-seb">seb365</span> <span class="header-logo-pro">pro</span></span>
            </h1>
            <p>Gestión de inventario simplificada</p>
            <div id="login-view">
            <form id="login-form" autocomplete="on">
                <div class="auth-form-fields">
                    <input type="email" id="login-email" placeholder="Correo electrónico" required>
                    <div class="password-wrapper">
                        <input type="password" id="login-password" placeholder="Contraseña" required>
                        <button type="button" class="password-toggle-btn" title="Mostrar/Ocultar contraseña">${ICONS.eye}</button>
                    </div>
                </div>
                <button type="submit">Ingresar</button>
                <button id="google-login-btn" type="button" class="button-secondary" style="margin-top: 12px; display:flex;justify-content:center;align-items:center;"><svg viewBox="0 0 48 48" style="width:18px;height:18px;margin-right:8px;"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg><span>Entrar con Google</span></button>
            </form>
            <p style="margin-top:20px; font-size: 14px;">¿No tienes cuenta? <a href="#" id="show-register-link">Regístrate</a></p>
            </div>
            <div id="register-view" class="hidden">
            <h2>Paso 1: Datos Personales</h2>
            <form id="register-personal-form" autocomplete="on">
                <div class="auth-form-fields">
                    <input type="text" id="register-name" placeholder="Nombre completo" required>
                    <input type="tel" id="register-phone" placeholder="Número de teléfono" required>
                    <input type="email" id="register-email" placeholder="Correo electrónico" required>
                    <div class="password-wrapper">
                        <input type="password" id="register-password" placeholder="Contraseña (mín. 6 caracteres)" required>
                        <button type="button" class="password-toggle-btn" title="Mostrar/Ocultar contraseña">${ICONS.eye}</button>
                    </div>
                    <div class="password-wrapper">
                        <input type="password" id="register-password-confirm" placeholder="Confirmar contraseña" required>
                        <button type="button" class="password-toggle-btn" title="Mostrar/Ocultar contraseña">${ICONS.eye}</button>
                    </div>
                </div>
                <button type="submit">Siguiente</button>
            </form>
            <p style="margin-top:20px; font-size: 14px;">¿Ya tienes cuenta? <a href="#" id="show-login-link">Inicia sesión</a></p>
            </div>
            <div id="register-business-view" class="hidden">
            <h2>Paso 2: Datos del Negocio</h2>
            <form id="register-business-form" autocomplete="on">
                <div class="auth-form-fields">
                    <input type="text" id="register-business-name" placeholder="Nombre del negocio" required>
                    <select id="register-business-type" required><option value="">Tipo de negocio...</option><option value="bar">Bar</option><option value="discoteca">Discoteca</option><option value="cafeteria">Cafetería</option><option value="restaurante">Restaurante</option></select>
                </div>
                <button type="submit">Crear Cuenta</button>
            </form>
            </div>
        </div>`;

        document.getElementById("login-form").addEventListener("submit", async (e) => { e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.disabled=true; signInWithEmailAndPassword(auth, document.getElementById("login-email").value, document.getElementById("login-password").value).catch(err=>showToast(err.message,"error")).finally(()=>{btn.disabled=false;}); });
        document.getElementById("google-login-btn").addEventListener("click", async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(err) { showToast(err.message, "error"); } });
        document.getElementById("register-personal-form").addEventListener("submit", (e) => { 
            e.preventDefault(); 
            const password = document.getElementById("register-password").value;
            const confirmPassword = document.getElementById("register-password-confirm").value;
            if (password !== confirmPassword) {
                showToast("Las contraseñas no coinciden.", "error");
                return;
            }
            registrationData.displayName = document.getElementById("register-name").value; 
            registrationData.phone = document.getElementById("register-phone").value; 
            registrationData.email = document.getElementById("register-email").value; 
            registrationData.password = password;
            document.getElementById("register-view").classList.add("hidden"); 
            document.getElementById("register-business-view").classList.remove("hidden"); 
        });
        document.getElementById("register-business-form").addEventListener("submit", async (e) => { 
            e.preventDefault(); 
            const btn = e.target.querySelector('button[type="submit"]'); 
            btn.disabled = true; 
            registrationData.businessName = document.getElementById("register-business-name").value; 
            registrationData.businessType = document.getElementById("register-business-type").value; 
            try { 
                const cred = await createUserWithEmailAndPassword(auth, registrationData.email, registrationData.password); 
                const batch = writeBatch(db);
                const userRef = doc(db, "users", cred.user.uid);
                batch.set(userRef, { 
                    email: registrationData.email, 
                    displayName: registrationData.displayName,
                    createdAt: serverTimestamp()
                });
                const tenantRef = doc(db, "tenants", cred.user.uid);
                batch.set(tenantRef, {
                    ownerName: registrationData.displayName,
                    ownerEmail: registrationData.email,
                    phone: registrationData.phone,
                    businessName: registrationData.businessName,
                    businessType: registrationData.businessType,
                    role: "admin",
                    active: true,
                    createdAt: serverTimestamp()
                });
                await batch.commit();
                showToast("Cuenta creada exitosamente"); 
                registrationData = {}; 
            } catch(err) { 
                showToast(err.message, "error"); 
                document.getElementById("register-view").classList.remove("hidden"); 
                document.getElementById("register-business-view").classList.add("hidden"); 
            } finally { 
                btn.disabled = false; 
            } 
        });
        document.getElementById("show-register-link").addEventListener("click", (e) => { e.preventDefault(); document.getElementById("login-view").classList.add("hidden"); document.getElementById("register-business-view").classList.add("hidden"); document.getElementById("register-view").classList.remove("hidden"); });
        document.getElementById("show-login-link").addEventListener("click", (e) => { e.preventDefault(); document.getElementById("register-view").classList.add("hidden"); document.getElementById("register-business-view").classList.add("hidden"); document.getElementById("login-view").classList.remove("hidden"); });
        authContainer.addEventListener('click', (e) => {
            const toggleBtn = e.target.closest('.password-toggle-btn');
            if (toggleBtn) {
                const passwordInput = toggleBtn.previousElementSibling;
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleBtn.innerHTML = ICONS.eyeOff;
                } else {
                    passwordInput.type = 'password';
                    toggleBtn.innerHTML = ICONS.eye;
                }
            }
        });
    }
   
    let persistentHandlersAttached = false;
    onAuthStateChanged(auth, async (user) => {
      const splash = document.getElementById('splash-screen');
      if (user) {
        buildColRef();
        const tenantDocRef = doc(db, "tenants", user.uid);
        const tenantDoc = await getDoc(tenantDocRef);
        appState.user = user;
        appState.userData = tenantDoc.exists() ? tenantDoc.data() : { email: user.email };
        appState.role = appState.userData.role || "admin";
        document.body.dataset.role = appState.role;
        document.getElementById("auth-container").classList.add("hidden");
        document.getElementById("app-container").classList.remove("hidden");
        document.querySelector('.nav-link[data-view="dashboard-view"]').classList.add("active");
        if (!persistentHandlersAttached) {
            attachPersistentHandlers();
            persistentHandlersAttached = true;
        }
        initRealtime();
        scheduleRender("dashboard-view");
      } else {
        appState.unsub.forEach(u => u());
        Object.values(stockUnsubscribers).forEach(unsub => unsub());
        stockUnsubscribers = {};
        appState = { user: null, userData: null, role: null, unsub: [], products: [], providers: [], workers: [], inventory: {}, cashflow: [], activeShifts: [], selectedShiftId: null };
        document.getElementById("app-container").classList.add("hidden");
        document.getElementById("auth-container").classList.remove("hidden");
        renderAuthUI();
        persistentHandlersAttached = false;
      }
      if (splash) {
          splash.classList.add('hidden');
          setTimeout(() => splash.remove(), 600);
      }
    });

    function initRealtime(){
      if(!tenantId()) return;
      appState.unsub.forEach(u=>u()); 
      appState.unsub=[];
      
      // Limpiar listeners de stock anteriores para evitar duplicados al recargar
      Object.values(stockUnsubscribers).forEach(unsub => unsub());
      stockUnsubscribers = {};

      const add = (un)=> appState.unsub.push(un);

      // El listener de productos ahora también gestiona los listeners de stock
      add(onSnapshot(query(colref.products, orderBy("nombre")), (snapshot) => {
          const newProducts = snapshot.docs.map(d => ({id:d.id, ...d.data()}));
          const newProductIds = new Set(newProducts.map(p => p.id));

          // Desuscribirse de listeners de stock para productos eliminados
          for (const productId in stockUnsubscribers) {
              if (!newProductIds.has(productId)) {
                  stockUnsubscribers[productId].forEach(unsub => unsub());
                  delete stockUnsubscribers[productId];
                  delete appState.inventory[productId];
              }
          }

          appState.products = newProducts;

          // Crear listeners para productos nuevos
          appState.products.forEach(product => {
              if (!stockUnsubscribers[product.id]) {
                  const unsubBodega = onSnapshot(stockRef(product.id, 'bodega'), (docSnap) => {
                      if (!appState.inventory[product.id]) appState.inventory[product.id] = {};
                      appState.inventory[product.id].bodega = docSnap.data() || { unidades: 0 };
                      scheduleRender();
                  });
                  const unsubBarra = onSnapshot(stockRef(product.id, 'barra'), (docSnap) => {
                      if (!appState.inventory[product.id]) appState.inventory[product.id] = {};
                      appState.inventory[product.id].barra = docSnap.data() || { unidades: 0 };
                      scheduleRender();
                  });
                  stockUnsubscribers[product.id] = [unsubBodega, unsubBarra];
              }
          });
          scheduleRender();
      }));

      add(onSnapshot(query(colref.providers, orderBy("nombre")), s=>{ appState.providers = s.docs.map(d=>({id:d.id, ...d.data()})); scheduleRender(); }));
      add(onSnapshot(query(colref.workers, orderBy("nombre")), s=>{ appState.workers = s.docs.map(d=>({id:d.id, ...d.data()})); scheduleRender(); }));
      add(onSnapshot(query(colref.cashflow, orderBy("date","desc")), s=>{ appState.cashflow = s.docs.map(d=>({id:d.id, ...d.data()})); scheduleRender(); }));
      
      add(onSnapshot(query(colref.shifts, where("estado", "==", "abierto")), (snapshot) => {
        const currentShiftIds = snapshot.docs.map(doc => doc.id);
        const previousShiftIds = appState.activeShifts.map(shift => shift.id);
        previousShiftIds.forEach(shiftId => {
            if (!currentShiftIds.includes(shiftId) && shiftSubListeners[shiftId]) {
                shiftSubListeners[shiftId].forEach(unsub => unsub());
                delete shiftSubListeners[shiftId];
            }
        });
        const shiftsData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        shiftsData.forEach((shiftData) => {
            const existingShiftIndex = appState.activeShifts.findIndex(s => s.id === shiftData.id);
            if (existingShiftIndex === -1) {
                const newShift = { ...shiftData, sales: [], loans: [] };
                appState.activeShifts.push(newShift);
                const salesUnsub = onSnapshot(
                  collection(db, "tenants", tenantId(), "shifts", shiftData.id, "sales"),
                  (salesSnapshot) => {
                    const shiftToUpdate = appState.activeShifts.find(s => s.id === shiftData.id);
                    if(shiftToUpdate) shiftToUpdate.sales = salesSnapshot.docs.map(d => ({id:d.id, ...d.data()}));
                    scheduleRender();
                  }
                );
                const loansUnsub = onSnapshot(
                  collection(db, "tenants", tenantId(), "shifts", shiftData.id, "loans"),
                  (loansSnapshot) => {
                    const shiftToUpdate = appState.activeShifts.find(s => s.id === shiftData.id);
                    if(shiftToUpdate) shiftToUpdate.loans = loansSnapshot.docs.map(d => ({id:d.id, ...d.data()}));
                    scheduleRender();
                  }
                );
                shiftSubListeners[shiftData.id] = [salesUnsub, loansUnsub];
            }
        });
        appState.activeShifts = appState.activeShifts.filter(s => currentShiftIds.includes(s.id));
        scheduleRender();
      }));
    }

    const content = document.getElementById("content");
    const row = (cols)=> `<tr>${cols.map(c=>`<td>${c}</td>`).join("")}</tr>`;
   
    function renderView(id) {
        let html = "";
        if (id === 'dashboard-view') {
            const balance = appState.cashflow.reduce((b, e) => b + (e.type === "ingreso" ? e.amount : -e.amount), 0);
            const totalSalesAllShifts = appState.activeShifts.reduce((total, shift) => total + shift.sales.reduce((subtotal, sale) => subtotal + sale.totalVenta, 0), 0);
            const debt = appState.providers.reduce((s, p) => s + (p.saldoPendiente || 0), 0);
            const low = appState.products.filter(p => (appState.inventory[p.id]?.barra?.unidades || 0) < 10).map(p => `<li>${p.nombre}: <strong>${appState.inventory[p.id]?.barra?.unidades || 0} uds</strong></li>`).join("");
            html = `<div class="content-view"><h2>Panel de Control</h2><div class="form-grid"><div class="card"><h3>Saldo en Caja</h3><p>${COP(balance)}</p></div><div class="card"><h3>Ventas (Turnos Activos)</h3><p>${COP(totalSalesAllShifts)}</p></div><div class="card"><h3>Deuda Proveedores</h3><p>${COP(debt)}</p></div><div class="card"><h3>Stock Crítico (Barra)</h3><ul>${low || "<li>Todo en orden</li>"}</ul></div></div></div>`;
        }
        if (id === 'products-view') {
            const rows = appState.products.map(p => row([ p.nombre, p.esFicha ? 'Sí' : 'No', COP(p.precioVenta || 0), COP(p.precioComision || 0), `<div class="actions"><button class="btn-edit" data-id="${p.id}">Editar</button></div>` ])).join("");
            html = `<div class="content-view"><h2>Productos y Fichas</h2><form id="product-form" class="card"><input type="hidden" id="product-id"><div class="form-grid"><input id="product-nombre" placeholder="Nombre" required><input id="product-precioVenta" type="number" step="any" min="0" placeholder="Precio Venta" required><input id="product-precioCompra" type="number" step="any" min="0" placeholder="Precio Compra" required><input id="product-precioComision" type="number" step="any" min="0" placeholder="Valor para Pago (Comisión)"><input id="product-unidadesPorCaja" type="number" min="1" placeholder="Unid. por Caja"><input id="product-unidadesPorCanasta" type="number" min="1" placeholder="Unid. por Canasta"></div><div style="margin-top: 16px;"><label style="display:inline-flex; align-items:center; gap: 8px; font-size: 16px;"><input id="product-esFicha" type="checkbox"> Es una Ficha</label></div><button type="submit" style="margin-top: 16px;">Guardar</button></form><div class="table-wrapper" style="margin-top:24px"><table><thead><tr><th>Nombre</th><th>Es Ficha</th><th>P. Venta</th><th>Valor Pago</th><th>Acciones</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
        }
        if (id === 'inventory-view') {
            const rows = appState.products.map(p=> row([ p.nombre, appState.inventory[p.id]?.bodega?.unidades ?? 0, appState.inventory[p.id]?.barra?.unidades ?? 0 ])).join("");
            const productOpts = appState.products.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join("");
            const providerOpts = appState.providers.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join("");
            html = `<div class="content-view"><h2>Inventario y Compras</h2><div class="form-grid"><form id="purchase-form" class="card"><h3>Registrar Compra</h3><div style="display: flex; flex-direction: column; gap: 12px;"><select id="purchase-provider" required><option value="">Proveedor…</option>${providerOpts}</select><select id="purchase-product" required><option value="">Producto…</option>${productOpts}</select><input id="purchase-quantity" type="number" min="1" placeholder="Cantidad" required><select id="purchase-unit" required><option value="unidades">Unidades</option><option value="cajas">Cajas</option><option value="canastas">Canastas</option></select><select id="purchase-type" required><option value="contado">Contado (Afecta caja)</option><option value="consignacion">Consignación</option></select><button type="submit">Registrar Compra</button></div></form><form id="transfer-form" class="card"><h3>Trasladar Bodega → Barra</h3><div style="display: flex; flex-direction: column; gap: 12px;"><select id="transfer-product" required><option value="">Producto…</option>${productOpts}</select><input id="transfer-quantity" type="number" min="1" placeholder="Cantidad" required><select id="transfer-unit" required><option value="unidades">Unidades</option><option value="cajas">Cajas</option><option value="canastas">Canastas</option></select><button type="submit">Trasladar</button></div></form></div><h3 style="margin:24px 0 12px 0;">Stock Actual</h3><div class="table-wrapper"><table><thead><tr><th>Producto</th><th>Stock Bodega</th><th>Stock Barra</th></tr></thead><tbody>${rows || `<tr><td colspan="3">Sin stock.</td></tr>`}</tbody></table></div></div>`;
        }
        if (id === 'cashflow-view') {
            const rows = appState.cashflow.map(e=>`<tr><td>${fmtDate(e.date)}</td><td>${e.description}</td><td class="${e.type==="ingreso"?"amount-positive":"amount-negative"}" style="font-weight: 500;">${COP(e.type==="ingreso"?e.amount:-e.amount)}</td></tr>`).join("");
            html = `<div class="content-view"><h2>Flujo de Caja</h2><form id="cashflow-form" class="card"><div class="form-grid" style="align-items: flex-end;"><select id="cashflow-type" required><option value="ingreso">Ingreso</option><option value="egreso">Egreso</option></select><input id="cashflow-amount" type="number" step="any" min="1" placeholder="Monto" required></div><input id="cashflow-description" placeholder="Descripción" required style="margin: 12px 0;"><button type="submit">Registrar</button></form><h3 style="margin:24px 0 12px 0;">Historial</h3><div class="table-wrapper"><table><thead><tr><th>Fecha</th><th>Descripción</th><th>Monto</th></tr></thead><tbody>${rows || `<tr><td colspan="3">Sin movimientos.</td></tr>`}</tbody></table></div></div>`;
        }
        if (id === 'providers-view') {
            const rows = appState.providers.map(p=> row([ p.nombre, (p.consignacion?"✅":"❌"), COP(p.saldoPendiente||0), `<div class="actions ${appState.role!=="admin"?"hidden":""}"><button class="btn-edit-provider" data-id="${p.id}">Editar</button><button class="btn-settle button-secondary" data-id="${p.id}">Liquidar</button></div>` ])).join("");
            html = `<div class="content-view"><h2>Proveedores</h2><form id="provider-form" class="card ${appState.role==="admin"?"":"hidden"}"><input type="hidden" id="provider-id"><div class="form-grid" style="margin-bottom: 12px;"><input id="provider-nombre" placeholder="Nombre del proveedor" required><input id="provider-contacto" placeholder="Contacto"></div><label style="display:inline-flex; align-items:center; gap: 8px;"><input id="provider-consignacion" type="checkbox"> Acepta consignación</label><button type="submit">Guardar Proveedor</button></form><div id="settlement-details" class="hidden card" style="margin-top:12px; border-left: 4px solid var(--brand-primary);"><h4>Liquidar a: <span id="settlement-provider-name"></span></h4><p>Saldo: <strong id="settlement-provider-balance"></strong></p><button id="settle-provider-btn">Pagar y Registrar Egreso</button></div><h3 style="margin:24px 0 12px 0;">Lista</h3><div class="table-wrapper"><table><thead><tr><th>Nombre</th><th>Consignación</th><th>Saldo</th><th>Acciones</th></tr></thead><tbody>${rows || `<tr><td colspan="4">Sin proveedores.</td></tr>`}</tbody></table></div></div>`;
        }
        if (id === 'workers-view') {
            const rows = appState.workers.map(w=> row([ w.nombre, COP(w.pagoBase||0), (w.activo?"✅":"❌"), `<div class="actions"><button class="btn-edit-worker" data-id="${w.id}">Editar</button></div>` ])).join("");
            html = `<div class="content-view"><h2>Trabajadores</h2><form id="worker-form" class="card"><input type="hidden" id="worker-id"><div class="form-grid" style="margin-bottom: 12px;"><input id="worker-nombre" placeholder="Nombre completo" required><input id="worker-pagoBase" type="number" step="any" min="0" placeholder="Pago base (opcional)"></div><label style="display:inline-flex; align-items:center; gap: 8px;"><input id="worker-activo" type="checkbox" checked> Activo</label><button type="submit">Guardar Trabajador</button></form><h3 style="margin:24px 0 12px 0;">Lista</h3><div class="table-wrapper"><table><thead><tr><th>Nombre</th><th>Pago Base</th><th>Activo</th><th>Acciones</th></tr></thead><tbody>${rows || `<tr><td colspan="4">Sin trabajadores.</td></tr>`}</tbody></table></div></div>`;
        }
        if (id === 'profile-view') {
            const u = appState.userData || {};
            html = `<div class="content-view"><h2>Mi Perfil</h2><div class="form-grid"><div class="card"><h2>Datos Personales</h2><form id="profile-personal-form"><div class="form-grid" style="gap: 12px; margin-bottom: 12px;"><div><label for="profile-name">Nombre</label><input id="profile-name" value="${u.ownerName || ''}"></div><div><label for="profile-phone">Teléfono</label><input id="profile-phone" type="tel" value="${u.phone || ''}"></div></div><label for="profile-email">Correo (no se puede cambiar)</label><input id="profile-email" type="email" value="${u.ownerEmail || ''}" disabled><button type="submit" style="margin-top: 16px;">Guardar Datos Personales</button></form></div><div class="card"><h2>Datos del Negocio</h2><form id="profile-business-form"><div style="margin-bottom: 12px;"><label for="profile-business-name">Nombre del Negocio</label><input id="profile-business-name" value="${u.businessName || ''}"></div><div style="margin-bottom: 12px;"><label for="profile-business-type">Tipo de Negocio</label><select id="profile-business-type"><option value="bar" ${u.businessType === 'bar' ? 'selected' : ''}>Bar</option><option value="discoteca" ${u.businessType === 'discoteca' ? 'selected' : ''}>Discoteca</option><option value="cafeteria" ${u.businessType === 'cafeteria' ? 'selected' : ''}>Cafetería</option><option value="restaurante" ${u.businessType === 'restaurante' ? 'selected' : ''}>Restaurante</option></select></div><button type="submit" style="margin-top: 16px;">Guardar Datos del Negocio</button></form></div></div><div class="card" style="margin-top: 24px;"><h2>Licencia</h2><p><strong>Tipo de plan:</strong> PRO</p><p><strong>Estado:</strong> Activa</p><p style="color: var(--text-secondary);">Esta sección se habilitará en futuras actualizaciones.</p></div></div>`;
        }
        if (id === 'shifts-view') {
            if (appState.selectedShiftId) {
                const shift = appState.activeShifts.find(s => s.id === appState.selectedShiftId);
                if (!shift) { appState.selectedShiftId = null; return renderView('shifts-view'); }
                const worker = appState.workers.find(w => w.id === shift.workerId);
                const ingresos = shift.sales.reduce((s, x) => s + x.totalVenta, 0);
                const comisiones = shift.sales.reduce((s, x) => s + (x.totalComision || 0), 0);
                const prestamos = shift.loans.reduce((s, l) => s + l.valor, 0);
                const fichaProducts = appState.products.filter(p => p.esFicha);
                const fichaCardsHTML = fichaProducts.map(ficha => {
                    const stock = appState.inventory[ficha.id]?.barra?.unidades ?? 0;
                    return `<div class="ficha-card" data-product-id="${ficha.id}"><h4>${ficha.nombre}</h4><div class="ficha-card-stock">${stock} <span>uds.</span></div></div>`;
                }).join("");
                html = `<div class="content-view">
                    <button id="back-to-shifts-list" class="button-secondary" style="margin-bottom: 24px;">&larr; Volver a la lista de turnos</button>
                    <h2>Gestionando Turno: <span style="color: var(--brand-primary);">${worker?.nombre || "…"}</span></h2>
                    <h3 style="margin-top: 24px;">Vender Fichas</h3>
                    <div id="fichas-grid">${fichaCardsHTML || "<p>No hay fichas activas configuradas.</p>"}</div>
                    <div class="card" style="margin-top:24px">
                        <h4>Resumen del Turno</h4>
                        <p><strong>Ingresos (Ventas):</strong> ${COP(ingresos)}</p>
                        <p><strong>Total para Pago (Comisiones):</strong> ${COP(comisiones)}</p>
                        <p><strong>Préstamos:</strong> ${COP(prestamos)}</p>
                        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 16px 0;">
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button id="open-loan-modal-btn" class="button-secondary">Registrar Préstamo</button>
                            <button id="close-shift-btn" data-shift-id="${shift.id}" style="background: var(--accent-red); flex-grow: 1;">Cerrar y Liquidar Turno</button>
                        </div>
                    </div>
                </div>`;
            } else {
                const workerOpts = appState.workers.filter(w => w.activo && !appState.activeShifts.some(s => s.workerId === w.id)).map(w => `<option value="${w.id}">${w.nombre}</option>`).join("");
                const activeShiftsHTML = appState.activeShifts.map(shift => {
                    const worker = appState.workers.find(w => w.id === shift.workerId);
                    return `<div class="active-shift-item">
                        <div class="active-shift-item-info"><strong>${worker?.nombre || 'Desconocido'}</strong><span>Inició: ${fmtDate(shift.inicio)}</span></div>
                        <div class="active-shift-item-actions">
                            <button class="btn-view-desglose button-secondary" data-shift-id="${shift.id}">Ver Desglose</button>
                            <button class="btn-manage-shift" data-shift-id="${shift.id}">Gestionar</button>
                        </div>
                    </div>`;
                }).join("");
                html = `<div class="content-view">
                    <h2>Turnos y Ventas</h2>
                    <div class="card"><h3>Iniciar Nuevo Turno</h3><form id="open-shift-form"><select id="shift-worker" required style="margin-bottom: 12px;"><option value="">Seleccionar trabajador…</option>${workerOpts}</select><button type="submit">Iniciar Turno</button></form></div>
                    <h3 style="margin: 24px 0 12px 0;">Turnos Activos (${appState.activeShifts.length})</h3>
                    <div class="active-shifts-list">${activeShiftsHTML || "<p>No hay turnos activos en este momento.</p>"}</div>
                </div>`;
            }
        }
        if (html) { content.innerHTML = html; attachHandlers(id); }
    }
   
    function attachPersistentHandlers() {
        const fichaSaleForm = document.getElementById("ficha-sale-form");
        if(fichaSaleForm) fichaSaleForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const modal = document.getElementById("ficha-sale-modal");
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            const productId = document.getElementById("ficha-sale-product-id").value;
            const unidades = parseInt(document.getElementById("ficha-sale-quantity").value);
            const prod = appState.products.find(p => p.id === productId);
            if (!prod || isNaN(unidades) || unidades <= 0) { 
                showToast("Cantidad inválida", "error"); 
                btn.disabled = false; 
                return; 
            }

            try {
                // --- CORRECTO: Lógica de venta dentro de una transacción ---
                // Esto garantiza que el stock se descuente y la venta se registre atómicamente.
                await runTransaction(db, async (t) => {
                    const barraRef = stockRef(productId, "barra");
                    const ventaRef = doc(collection(db, "tenants", tenantId(), "shifts", appState.selectedShiftId, "sales"));
                    
                    const snap = await t.get(barraRef);
                    const currentStock = snap.data()?.unidades || 0;
                    
                    if (currentStock < unidades) { 
                        throw new Error(`Stock insuficiente para ${prod.nombre}. Solo hay ${currentStock}.`); 
                    }
                    
                    const newStock = currentStock - unidades;
                    t.set(barraRef, { tenantId: tenantId(), unidades: newStock }, { merge: true });

                    t.set(ventaRef, {
                        type: 'ficha', productId: productId, unidades: unidades,
                        totalVenta: unidades * (prod.precioVenta || 0), totalComision: unidades * (prod.precioComision || 0),
                        fecha: serverTimestamp()
                    });
                });
                
                showToast("Venta registrada");
                modal.classList.remove("visible");
            } catch(err) { 
                showToast(err.message, "error"); 
            } finally { 
                btn.disabled = false; 
            }
        });

        const loanForm = document.getElementById("loan-form");
        if (loanForm) loanForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!appState.selectedShiftId) return;
            const valor = parseFloat(document.getElementById("loan-value").value);
            const desc = document.getElementById("loan-description").value;
            if (isNaN(valor) || !desc) return;
            await addDoc(collection(db, "tenants", tenantId(), "shifts", appState.selectedShiftId, "loans"), { descripcion: desc, valor, fecha: serverTimestamp() });
            loanForm.reset();
            document.getElementById("loan-modal").classList.remove("visible");
        });
    }

    function attachHandlers(id){
        if (id === 'products-view') {
            content.querySelectorAll(".btn-edit").forEach(b => b.addEventListener("click", () => {
                const p = appState.products.find(x => x.id === b.dataset.id); if (!p) return;
                document.getElementById("product-id").value = p.id;
                document.getElementById("product-nombre").value = p.nombre || "";
                document.getElementById("product-precioVenta").value = p.precioVenta || 0;
                document.getElementById("product-precioCompra").value = p.precioCompra || 0;
                document.getElementById("product-precioComision").value = p.precioComision || 0;
                document.getElementById("product-unidadesPorCaja").value = p.unidadesPorCaja || 1;
                document.getElementById("product-unidadesPorCanasta").value = p.unidadesPorCanasta || 1;
                document.getElementById("product-esFicha").checked = !!p.esFicha;
            }));
            const form = document.getElementById("product-form");
            if (form) form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]'); btn.disabled = true;
                const id = document.getElementById("product-id").value;
                const data = {
                    nombre: document.getElementById("product-nombre").value,
                    precioVenta: parseFloat(document.getElementById("product-precioVenta").value),
                    precioCompra: parseFloat(document.getElementById("product-precioCompra").value),
                    precioComision: parseFloat(document.getElementById("product-precioComision").value) || 0,
                    unidadesPorCaja: parseInt(document.getElementById("product-unidadesPorCaja").value) || 1,
                    unidadesPorCanasta: parseInt(document.getElementById("product-unidadesPorCanasta").value) || 1,
                    esFicha: document.getElementById("product-esFicha").checked,
                    activo: true
                };
                try {
                    if (id) {
                        await setDoc(doc(colref.products, id), data, { merge: true });
                    } else {
                        const ref = await addDoc(colref.products, data);
                        const b = writeBatch(db);
                        b.set(stockRef(ref.id, "bodega"), { tenantId: tenantId(), unidades: 0 }, { merge: true });
                        b.set(stockRef(ref.id, "barra"), { tenantId: tenantId(), unidades: 0 }, { merge: true });
                        await b.commit();
                    }
                    showToast("Guardado correctamente");
                    form.reset(); document.getElementById("product-id").value = "";
                } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
            });
        }
        if(id === 'inventory-view') {
            const purchaseForm = document.getElementById("purchase-form");
            if (purchaseForm) {
                purchaseForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const btn = purchaseForm.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    
                    const providerId = document.getElementById("purchase-provider").value;
                    const productId = document.getElementById("purchase-product").value;
                    const cantidad = parseInt(document.getElementById("purchase-quantity").value);
                    const unit = document.getElementById("purchase-unit").value;
                    const tipo = document.getElementById("purchase-type").value;
                    const prod = appState.products.find(p => p.id === productId);

                    if (!prod || !providerId || isNaN(cantidad) || cantidad <= 0) {
                        showToast("Datos de compra inválidos", "error");
                        btn.disabled = false;
                        return;
                    }

                    try {
                        const unidades = toUnidades(cantidad, unit, prod);
                        const costo = unidades * (prod.precioCompra || 0);

                        await runTransaction(db, async (t) => {
                            const bodegaRef = stockRef(productId, "bodega");
                            const purchaseRef = doc(colref.purchases);
                            
                            const bodegaSnap = await t.get(bodegaRef);
                            const currentStock = bodegaSnap.data()?.unidades || 0;
                            const newStock = currentStock + unidades;
                            
                            t.set(bodegaRef, { tenantId: tenantId(), unidades: newStock }, { merge: true });

                            t.set(purchaseRef, {
                                providerId, productId, fecha: serverTimestamp(), tipo,
                                cantidadUnidades: unidades, costoTotal: costo
                            });

                            if (tipo === "consignacion") {
                                const providerRef = doc(colref.providers, providerId);
                                t.set(providerRef, { saldoPendiente: increment(costo) }, { merge: true });
                            } else {
                                const cashflowRef = doc(colref.cashflow); 
                                t.set(cashflowRef, {
                                    type: "egreso", amount: costo,
                                    description: `Compra contado: ${unidades} x ${prod.nombre}`,
                                    date: serverTimestamp()
                                });
                            }
                        });

                        showToast("Compra registrada exitosamente");
                        purchaseForm.reset();
                    } catch (err) {
                        showToast(`Error en la compra: ${err.message}`, "error");
                    } finally {
                        btn.disabled = false;
                    }
                });
            }
            const transferForm = document.getElementById("transfer-form");
            if (transferForm) {
                transferForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const btn = transferForm.querySelector('button[type="submit"]');
                    btn.disabled = true;

                    const productId = document.getElementById("transfer-product").value;
                    const cantidad = parseInt(document.getElementById("transfer-quantity").value);
                    const unit = document.getElementById("transfer-unit").value;
                    const prod = appState.products.find(p => p.id === productId);
                    
                    if (!prod || isNaN(cantidad) || cantidad <= 0) {
                        showToast("Datos de traslado inválidos", "error");
                        btn.disabled = false;
                        return;
                    }
                    
                    const unidades = toUnidades(cantidad, unit, prod);
                    try {
                        await runTransaction(db, async (t) => {
                            const bodegaRef = stockRef(productId, "bodega");
                            const barraRef = stockRef(productId, "barra");
                            
                            const [bodegaSnap, barraSnap] = await Promise.all([t.get(bodegaRef), t.get(barraRef)]);
                            
                            const currentBodegaStock = bodegaSnap.data()?.unidades || 0;
                            if (currentBodegaStock < unidades) {
                                throw new Error("Stock insuficiente en bodega.");
                            }
                            
                            const currentBarraStock = barraSnap.data()?.unidades || 0;
                            const newBodegaStock = currentBodegaStock - unidades;
                            const newBarraStock = currentBarraStock + unidades;
                            
                            t.set(bodegaRef, { tenantId: tenantId(), unidades: newBodegaStock }, { merge: true });
                            t.set(barraRef, { tenantId: tenantId(), unidades: newBarraStock }, { merge: true });
                        });
                        showToast("Traslado exitoso");
                        transferForm.reset();
                    } catch (err) {
                        showToast(`Error en traslado: ${err.message}`, "error");
                    } finally {
                        btn.disabled = false;
                    }
                });
            }
        }
        if(id === 'cashflow-view') {
            const form = document.getElementById("cashflow-form");
            if (form) {
                form.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const btn = form.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    const data = {
                        type: document.getElementById("cashflow-type").value,
                        amount: parseFloat(document.getElementById("cashflow-amount").value),
                        description: document.getElementById("cashflow-description").value,
                        date: serverTimestamp(),
                        manual: true,
                        userId: appState.user.uid
                    };
                    try {
                        await addDoc(colref.cashflow, data);
                        showToast("Movimiento registrado");
                        form.reset();
                    } catch (err) {
                        showToast(err.message, "error");
                    } finally {
                        btn.disabled = false;
                    }
                });
            }
        }
        if (id === 'providers-view') {
            content.querySelectorAll(".btn-edit-provider").forEach(b => b.addEventListener("click", () => {
                const p = appState.providers.find(x => x.id === b.dataset.id); if (!p) return;
                document.getElementById("provider-id").value = p.id;
                document.getElementById("provider-nombre").value = p.nombre || "";
                document.getElementById("provider-contacto").value = p.contacto || "";
                document.getElementById("provider-consignacion").checked = !!p.consignacion;
            }));
            const form = document.getElementById("provider-form");
            if (form) {
                form.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const btn = form.querySelector('button[type="submit"]'); btn.disabled = true;
                    const id = document.getElementById("provider-id").value;
                    const data = {
                        nombre: document.getElementById("provider-nombre").value,
                        contacto: document.getElementById("provider-contacto").value,
                        consignacion: document.getElementById("provider-consignacion").checked
                    };
                    try {
                        if (id) {
                            await setDoc(doc(colref.providers, id), data, { merge: true });
                        } else {
                            await addDoc(colref.providers, { ...data, saldoPendiente: 0 });
                        }
                        showToast("Proveedor guardado");
                        form.reset(); document.getElementById("provider-id").value = "";
                    } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
                });
            }
            content.querySelectorAll(".btn-settle").forEach(b => b.addEventListener("click", () => {
                const prov = appState.providers.find(x => x.id === b.dataset.id); if (!prov) return;
                if ((prov.saldoPendiente || 0) <= 0) { showToast("Proveedor sin saldo pendiente", "error"); return; }
                document.getElementById("settlement-provider-name").textContent = prov.nombre;
                document.getElementById("settlement-provider-balance").textContent = COP(prov.saldoPendiente || 0);
                document.getElementById("settle-provider-btn").dataset.providerId = prov.id;
                document.getElementById("settlement-details").classList.remove("hidden");
            }));
            const settleBtn = document.getElementById("settle-provider-btn");
            if (settleBtn) {
                settleBtn.addEventListener("click", async (e) => {
                    const providerId = e.target.dataset.providerId;
                    const prov = appState.providers.find(p => p.id === providerId); if (!prov) return;
                    const batch = writeBatch(db);
                    batch.set(doc(colref.cashflow), {
                        type: "egreso", amount: prov.saldoPendiente,
                        description: `Pago liquidación: ${prov.nombre}`, date: serverTimestamp()
                    });
                    batch.set(doc(colref.providers, providerId), { saldoPendiente: 0 }, { merge: true });
                    try {
                        await batch.commit();
                        showToast("Liquidación realizada");
                        document.getElementById("settlement-details").classList.add("hidden");
                    } catch (err) { showToast(err.message, "error"); }
                });
            }
        }
        if (id === 'workers-view') {
            content.querySelectorAll(".btn-edit-worker").forEach(b => b.addEventListener("click", () => {
                const w = appState.workers.find(x => x.id === b.dataset.id);
                if (!w) return;
                const form = document.getElementById("worker-form");
                form.querySelector("#worker-id").value = w.id;
                form.querySelector("#worker-nombre").value = w.nombre || "";
                form.querySelector("#worker-pagoBase").value = w.pagoBase || 0;
                form.querySelector("#worker-activo").checked = w.activo === true;
            }));
            const form = document.getElementById("worker-form");
            if (form) {
                form.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const btn = form.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    const workerId = document.getElementById("worker-id").value;
                    const data = {
                        nombre: document.getElementById("worker-nombre").value.trim(),
                        pagoBase: parseFloat(document.getElementById("worker-pagoBase").value) || 0,
                        activo: document.getElementById("worker-activo").checked,
                    };
                    if (!data.nombre) {
                        showToast("El nombre del trabajador es requerido.", "error");
                        btn.disabled = false;
                        return;
                    }
                    try {
                        if (workerId) {
                            await setDoc(doc(colref.workers, workerId), data, { merge: true });
                        } else {
                            await addDoc(colref.workers, { ...data, createdAt: serverTimestamp() });
                        }
                        showToast("Trabajador guardado correctamente.");
                        form.reset();
                        document.getElementById("worker-id").value = "";
                        document.getElementById("worker-activo").checked = true;
                    } catch (err) {
                        showToast(`Error: ${err.message}`, "error");
                    } finally {
                        btn.disabled = false;
                    }
                });
            }
        }
        if (id === 'profile-view') {
            const personalForm = document.getElementById("profile-personal-form");
            if (personalForm) {
                personalForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
                    try {
                        const tenantRef = doc(db, "tenants", appState.user.uid);
                        const newDisplayName = document.getElementById("profile-name").value;
                        const newPhone = document.getElementById("profile-phone").value;
                        await setDoc(tenantRef, { ownerName: newDisplayName, phone: newPhone }, { merge: true });
                        appState.userData.ownerName = newDisplayName;
                        appState.userData.phone = newPhone;
                        showToast("Datos personales actualizados");
                    } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
                });
            }
            const businessForm = document.getElementById("profile-business-form");
            if (businessForm) {
                businessForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
                    try {
                        const tenantRef = doc(db, "tenants", appState.user.uid);
                        const newBusinessName = document.getElementById("profile-business-name").value;
                        const newBusinessType = document.getElementById("profile-business-type").value;
                        await setDoc(tenantRef, { businessName: newBusinessName, businessType: newBusinessType }, { merge: true });
                        appState.userData.businessName = newBusinessName;
                        appState.userData.businessType = newBusinessType;
                        showToast("Datos del negocio actualizados");
                    } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
                });
            }
        }
        if(id === 'shifts-view') {
            if (appState.selectedShiftId) {
                document.getElementById("back-to-shifts-list")?.addEventListener("click", () => {
                    appState.selectedShiftId = null;
                    scheduleRender();
                });
                document.getElementById("fichas-grid")?.addEventListener("click", (e) => {
                    const card = e.target.closest(".ficha-card");
                    if (!card) return;
                    const productId = card.dataset.productId;
                    const product = appState.products.find(p => p.id === productId);
                    const stock = appState.inventory[productId]?.barra?.unidades ?? 0;
                    const modal = document.getElementById("ficha-sale-modal");
                    modal.querySelector("#ficha-sale-modal-title").textContent = `Vender ${product.nombre}`;
                    modal.querySelector("#ficha-sale-product-id").value = productId;
                    modal.querySelector("#ficha-sale-stock").textContent = stock;
                    modal.querySelector("#ficha-sale-quantity").value = 1;
                    modal.classList.add("visible");
                });
                document.getElementById("open-loan-modal-btn")?.addEventListener("click", () => {
                    document.getElementById("loan-modal").classList.add("visible");
                });
                document.getElementById("close-shift-btn")?.addEventListener("click", async (e) => {
                    const btn = e.target;
                    const isConfirmed = btn.dataset.confirmed === 'true';
                    if (!isConfirmed) {
                        btn.dataset.originalText = btn.textContent;
                        btn.textContent = '¿Confirmar Cierre?';
                        btn.style.background = 'var(--brand-secondary)';
                        btn.dataset.confirmed = 'true';
                        const timeoutId = setTimeout(() => {
                            btn.textContent = btn.dataset.originalText;
                            btn.style.background = '';
                            btn.dataset.confirmed = 'false';
                        }, 4000);
                        btn.dataset.timeoutId = timeoutId;
                        return;
                    }
                    clearTimeout(btn.dataset.timeoutId);
                    btn.disabled = true;
                    const shiftId = btn.dataset.shiftId;
                    const shift = appState.activeShifts.find(s => s.id === shiftId);
                    if (!shift) { btn.disabled = false; return; }
                    const worker = appState.workers.find(w => w.id === shift.workerId);
                    const ingresos = shift.sales.reduce((s, x) => s + x.totalVenta, 0);
                    const comisiones = shift.sales.reduce((s, x) => s + (x.totalComision || 0), 0);
                    const prestamos = shift.loans.reduce((s, l) => s + l.valor, 0);
                    const totalAPagar = (worker?.pagoBase || 0) + comisiones - prestamos;
                    try {
                        const batch = writeBatch(db);
                        batch.set(doc(colref.cashflow), { type: "ingreso", amount: ingresos, description: `Cierre turno ${worker?.nombre || ""}`, date: serverTimestamp() });
                        if (totalAPagar > 0) {
                            batch.set(doc(colref.cashflow), { type: "egreso", amount: totalAPagar, description: `Pago liquidación ${worker?.nombre || ""}`, date: serverTimestamp() });
                        }
                        batch.set(doc(colref.shifts, shift.id), { estado: "cerrado", fin: serverTimestamp(), totalIngresos: ingresos, totalComisiones: comisiones, totalPrestamos: prestamos, totalPagado: totalAPagar }, { merge: true });
                        await batch.commit();
                        appState.selectedShiftId = null;
                        showToast("Turno cerrado y liquidado");
                    } catch (err) {
                        showToast(err.message, "error");
                        btn.textContent = btn.dataset.originalText;
                        btn.style.background = '';
                        btn.dataset.confirmed = 'false';
                        btn.disabled = false;
                    }
                });
            } else {
                document.getElementById("open-shift-form")?.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const workerId = document.getElementById("shift-worker").value;
                    if (!workerId) return;
                    const worker = appState.workers.find(w => w.id === workerId);
                    await addDoc(colref.shifts, {
                        workerId,
                        pagoBase: worker?.pagoBase || 0,
                        inicio: serverTimestamp(),
                        estado: "abierto"
                    });
                });
                content.querySelectorAll('.btn-manage-shift').forEach(btn => btn.addEventListener('click', (e) => {
                    appState.selectedShiftId = e.target.dataset.shiftId;
                    scheduleRender();
                }));
                content.querySelectorAll('.btn-view-desglose').forEach(btn => btn.addEventListener('click', (e) => {
                    const shiftId = e.target.dataset.shiftId;
                    const shift = appState.activeShifts.find(s => s.id === shiftId); if (!shift) return;
                    const worker = appState.workers.find(w => w.id === shift.workerId);
                    document.getElementById('desglose-modal-title').textContent = `Desglose de ${worker?.nombre || '...'}`;
                    const combinedEvents = [
                        ...shift.sales.map(s => ({ ...s, eventType: 'sale' })),
                        ...shift.loans.map(l => ({ ...l, eventType: 'loan' }))
                    ];
                    if (combinedEvents.length > 0 && combinedEvents[0].fecha?.toMillis) {
                        combinedEvents.sort((a, b) => a.fecha.toMillis() - b.fecha.toMillis());
                    }
                    const tableBody = combinedEvents.map(event => {
                        const time = event.fecha?.toDate().toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' }) || 'N/A';
                        if (event.eventType === 'sale') {
                            const product = appState.products.find(p => p.id === event.productId);
                            const description = `${event.unidades} x ${product?.nombre || 'Ficha vendida'}`;
                            return row([time, description, COP(event.totalVenta), COP(event.totalComision), '']);
                        } else {
                            return row([time, `Préstamo: ${event.descripcion}`, '', '', COP(event.valor)]);
                        }
                    }).join('');
                    document.getElementById('desglose-modal-body').innerHTML = `<table><thead><tr><th>Hora</th><th>Descripción</th><th>Ingreso</th><th>Comisión</th><th>Préstamo</th></tr></thead><tbody>${tableBody || `<tr><td colspan="5">No hay eventos registrados.</td></tr>`}</tbody></table>`;
                    document.getElementById('desglose-modal').classList.add('visible');
                }));
            }
        }
    }
    
    // --- Manejo de Modales ---
    document.querySelectorAll(".modal").forEach(modal => {
        const closeBtn = modal.querySelector(".modal-close-btn");
        if (closeBtn) {
            closeBtn.addEventListener("click", () => modal.classList.remove("visible"));
        }
        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.classList.remove("visible");
            }
        });
    });
  </script>
</body>
</html>

