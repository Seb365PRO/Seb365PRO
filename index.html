<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>seb365 pro</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- Librerías para Gráficos, PDF y Excel -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg-primary: #ffffff; --bg-secondary: #f8f9fa; --bg-tertiary: #f1f3f4;
      --border-color: #e0e0e0; --text-primary: #202124; --text-secondary: #5f6368;
      --brand-primary: #007bff; --brand-secondary: #0056b3; --accent-red: #d93025;
      --accent-green: #1e8e3e; --accent-blue: #1976d2; --accent-yellow-tag: #ffab00;
      --shadow-color: rgba(0, 0, 0, 0.08);
      --dark-bg-primary: #202124; --dark-bg-secondary: #303134; --dark-bg-tertiary: #3c4043;
      --dark-border-color: #424548; --dark-text-primary: #e8eaed; --dark-text-secondary: #9aa0a6;
      --dark-brand-primary: #00c6ff; --dark-brand-secondary: #0072ff; --dark-accent-red: #f28b82;
      --dark-accent-green: #81c995; --dark-accent-blue: #8ab4f8; --dark-accent-yellow-tag: #fdd663;
      --dark-shadow-color: rgba(0, 0, 0, 0.3);
      --grad-yellow: #00c6ff; --grad-orange: #0072ff; --grad-red: #0022ff;

      --glass-bg: rgba(20, 20, 20, 0.45);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: rgba(0, 0, 0, 0.2);
      --glass-blur: 12px;
    }
    body[data-theme="dark"] {
      --bg-primary: var(--dark-bg-primary); --bg-secondary: var(--dark-bg-secondary);
      --bg-tertiary: var(--dark-bg-tertiary); --border-color: var(--dark-border-color);
      --text-primary: var(--dark-text-primary); --text-secondary: var(--dark-text-secondary);
      --brand-primary: var(--dark-brand-primary); --brand-secondary: var(--dark-brand-secondary);
      --accent-red: var(--dark-accent-red); --accent-green: var(--dark-accent-green);
      --accent-blue: var(--dark-accent-blue); --accent-yellow-tag: var(--dark-accent-yellow-tag);
      --shadow-color: var(--dark-shadow-color);
      --glass-bg: rgba(20, 20, 20, 0.6);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; overflow-x: hidden; }
    body {
      margin: 0; font-family: 'Roboto', sans-serif;
      color: var(--dark-text-primary); transition: background-color 0.2s, color 0.2s;
      background-color: #111;

      background-image: radial-gradient(ellipse at bottom, #001f54, #000814 70%);
    }
    main { display: flex; min-height: calc(100vh - 60px); }
    #content { flex: 1; padding: 24px; padding-bottom: 80px; }
    .hidden { display: none !important; }

    /* --- Header y Logo --- */
    header {
      display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
      height: 60px;
      background: var(--glass-bg);
      border-bottom: 1px solid var(--glass-border);
      backdrop-filter: blur(var(--glass-blur));
      position: sticky; top: 0; z-index: 100;
    }
    .header-logo {
      margin: 0; font-size: 22px; font-weight: 700;
      display: flex; align-items: center; gap: 10px; text-decoration: none;
    }
    .header-logo-icon { width: 28px; height: 28px; }
    .header-logo-text {
      background: linear-gradient(90deg, var(--grad-yellow), var(--grad-orange), var(--grad-red));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .header-logo-pro { font-weight: 900; }
    body[data-theme="dark"] .header-logo-text { background: none; -webkit-background-clip: initial; background-clip: initial; }
    body[data-theme="dark"] .header-logo-seb { color: var(--dark-text-primary); }
    body[data-theme="dark"] .header-logo-pro {
      background: linear-gradient(90deg, var(--grad-yellow), var(--grad-orange), var(--grad-red));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }

    .user-info { display: flex; align-items: center; gap: 12px; font-size: 14px; }
    #main-nav {
      width: 250px; padding: 16px 8px;
      background: var(--glass-bg);
      border-right: 1px solid var(--glass-border);
      backdrop-filter: blur(var(--glass-blur));
      transition: left 0.3s ease-in-out;
      height: 100vh; position: sticky; top: 0;
    }
    #main-nav .nav-link {
      display: flex; gap: 16px; align-items: center; color: var(--text-secondary); padding: 10px 16px;
      border-radius: 8px; text-decoration: none; margin-bottom: 4px; font-weight: 500;
      transition: background-color 0.2s, color 0.2s;
    }
    #main-nav .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }
    #main-nav .nav-link.active {
      background-color: rgba(0, 114, 255, 0.2);
      color: var(--dark-brand-primary);
      font-weight: 700;
    }
    .nav-link svg { width: 20px; height: 20px; }
    .card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px var(--glass-shadow);
      backdrop-filter: blur(var(--glass-blur));
    }
    .content-view h2, .card h2 { margin: 0 0 24px 0; font-size: 24px; font-weight: 500; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
    input, select, button { font: inherit; outline-color: var(--brand-primary); }
    input, select {
      width: 100%; padding: 12px 14px; border-radius: 8px; border: 1px solid var(--border-color);
      background-color: var(--bg-primary); color: var(--text-primary); transition: border-color 0.2s;
    }
    .password-wrapper { position: relative; }
    .password-wrapper input { padding-right: 44px; }
    .password-toggle-btn {
      position: absolute; right: 4px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; padding: 8px; color: var(--text-secondary);
      display: flex; align-items: center; justify-content: center;
    }
    .password-toggle-btn:hover { color: var(--text-primary); }
    .password-toggle-btn svg { width: 20px; height: 20px; }
    input:focus, select:focus { border-color: var(--brand-primary); }
    button {
      background: linear-gradient(45deg, var(--grad-red), var(--grad-orange), var(--grad-yellow)); background-size: 200% auto;
      border: none; color: #fff; padding: 12px 18px; border-radius: 8px; cursor: pointer;
      font-weight: 500; transition: background-position 0.4s ease, background-color 0.3s ease;
    }
    button:hover { background-position: right center; }
    button[disabled] { opacity: .6; cursor: not-allowed; background-position: left center !important; }
    .button-secondary {
      background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color);
    }
    .button-secondary:hover { background: var(--border-color); }
    label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 14px; text-align: left; }
    .table-wrapper { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; border-spacing: 0; }
    thead th {
      font-weight: 500; color: var(--text-secondary); text-align: left; padding: 12px 16px;
      background-color: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);
    }
    tbody td { background: var(--bg-secondary); padding: 12px 16px; border-bottom: 1px solid var(--border-color); }
    tbody tr:last-child td { border-bottom: none; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .actions button { padding: 6px 10px; font-size: 14px; }
    #toast-container { position: fixed; right: 24px; bottom: 24px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
    .toast {
      padding: 14px 18px; border-radius: 8px; background-color: var(--bg-tertiary); border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px var(--shadow-color); color: var(--text-primary);
    }
    .toast.success { border-left: 4px solid var(--accent-green); }
    .toast.error { border-left: 4px solid var(--accent-red); }
    .amount-positive { color: var(--accent-green); } .amount-negative { color: var(--accent-red); }

    /* --- Autenticación Rediseñada --- */
    #auth-container {
        display: flex; align-items: center; justify-content: center; padding: 24px;
        min-height: 100vh;
        background-color: var(--bg-secondary);
    }
    .auth-box {
        max-width: 450px; width: 100%; text-align: center;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        padding: 32px; border-radius: 16px;
        box-shadow: 0 8px 32px var(--glass-shadow);
        backdrop-filter: blur(var(--glass-blur));
    }
    .auth-box h2 { font-size: 28px; font-weight: 700; margin: 16px 0 8px 0; }
    .auth-box p { color: var(--text-secondary); margin-bottom: 32px; }
    .auth-form-fields { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
    .auth-box button[type="submit"] { width: 100%; padding: 14px; font-size: 16px; }
    .auth-box .button-secondary { width: 100%; }
    .divider { display: flex; align-items: center; text-align: center; color: var(--text-secondary); font-size: 12px; margin: 24px 0; }
    .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--border-color); }
    .divider:not(:empty)::before { margin-right: .5em; }
    .divider:not(:empty)::after { margin-left: .5em; }
    .auth-switch-link { color: var(--brand-primary); text-decoration: none; font-weight: 500; }
    .auth-switch-link:hover { text-decoration: underline; }
    .register-fields-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
        display: flex; align-items: center; justify-content: center; z-index: 1000;
        opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .modal.visible { opacity: 1; pointer-events: all; }
    .modal-content {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      padding: 32px;
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      box-shadow: 0 5px 15px var(--glass-shadow);
      backdrop-filter: blur(var(--glass-blur));
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }
    .modal.visible .modal-content { transform: scale(1); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-header h3 { margin: 0; font-size: 22px; }
    .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); line-height: 1; }
    .modal-form-body { display: flex; flex-direction: column; gap: 20px; }
    #fichas-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 16px; margin-bottom: 24px;
    }
    .ficha-card {
        background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px;
        padding: 16px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
    }
    .ficha-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px var(--shadow-color); }
    .ficha-card h4 { margin: 0 0 8px 0; font-size: 16px; color: var(--text-primary); text-transform: uppercase; }
    .ficha-card-stock { font-size: 20px; font-weight: 700; color: var(--brand-primary); }
    .ficha-card-stock span { font-size: 12px; font-weight: 400; color: var(--text-secondary); }
    .active-shifts-list { display: flex; flex-direction: column; gap: 12px; }
    .active-shift-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color);
    }
    .active-shift-item-info { display: flex; flex-direction: column; }
    .active-shift-item-info strong { font-size: 18px; color: var(--text-primary); }
    .active-shift-item-info span { font-size: 14px; color: var(--text-secondary); }
    .active-shift-item-actions { display: flex; gap: 10px; }
    #mobile-footer {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 65px;
      background: var(--glass-bg);
      border-top: 1px solid var(--glass-border);
      backdrop-filter: blur(var(--glass-blur));
      box-shadow: 0 -2px 10px var(--glass-shadow);
      z-index: 50;
    }
    #mobile-footer-nav { display: flex; justify-content: space-around; align-items: center; height: 100%; }
    .mobile-nav-link {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-decoration: none; color: var(--text-secondary); flex-grow: 1;
      height: 100%; transition: color 0.2s;
    }
    .mobile-nav-link svg { width: 24px; height: 24px; margin-bottom: 4px; }
    .mobile-nav-link span { font-size: 10px; font-weight: 500; }
    .mobile-nav-link.active { color: var(--brand-primary); }

    /* --- Dashboard & Reportes --- */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .kpi-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }
    .kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 16px var(--shadow-color);
    }
    .kpi-card h3 {
        font-size: 14px; color: var(--text-secondary); font-weight: 500; margin: 0 0 8px 0;
    }
    .kpi-card p { font-size: 28px; font-weight: 700; margin: 0; }
    .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
    .chart-container h3 { margin-bottom: 16px; font-size: 18px; font-weight: 500; text-align: center;}
    .d3-tooltip {
        position: absolute; text-align: center;
        padding: 8px; font-size: 12px;
        background: var(--dark-bg-secondary); color: var(--dark-text-primary);
        border: 0px; border-radius: 8px; pointer-events: none;
        opacity: 0; transition: opacity 0.2s;
    }
    .axis path, .axis line { stroke: var(--border-color); }
    .axis text { fill: var(--text-secondary); }
    .status-tag {
        padding: 4px 10px; border-radius: 16px; font-size: 12px;
        font-weight: 500; text-transform: uppercase; display: inline-block;
    }
    .status-tag.ok { background-color: rgba(30, 142, 62, 0.1); color: var(--accent-green); }
    .status-tag.low { background-color: rgba(255, 171, 0, 0.1); color: var(--accent-yellow-tag); }
    .status-tag.out { background-color: rgba(217, 48, 37, 0.1); color: var(--accent-red); }
    .breakdown-summary p { margin: 4px 0; font-size: 16px; display: flex; justify-content: space-between; }
    .breakdown-summary p span:last-child { font-weight: 500; }
    .breakdown-summary hr { border: none; border-top: 1px solid var(--border-color); margin: 12px 0; }
    .breakdown-summary h4 { margin-top: 12px; display: flex; justify-content: space-between; font-size: 18px; }

    /* --- Notificaciones Mejoradas --- */
    .notification-container { position: relative; }
    #notification-counter {
        position: absolute; top: 0px; right: 0px;
        background-color: var(--accent-red); color: white;
        border-radius: 50%; width: 18px; height: 18px; font-size: 11px;
        display: flex; align-items: center; justify-content: center; font-weight: 700;
        border: 2px solid var(--bg-secondary);
    }
    #notification-dropdown {
        position: absolute; top: calc(100% + 10px); right: 0;
        width: 380px; z-index: 110;
        background-color: rgba(var(--bg-primary-rgb), 0.8);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(var(--border-color-rgb), 0.5);
        box-shadow: 0 8px 24px var(--shadow-color);
        border-radius: 12px;
        display: flex; flex-direction: column;
        overflow: hidden;
    }
    .notification-header {
        padding: 16px 20px; border-bottom: 1px solid var(--border-color);
    }
    .notification-header h3 { margin: 0; font-size: 18px;}
    #notification-list { flex-grow: 1; max-height: 350px; overflow-y: auto; }
    .notification-item {
        padding: 12px 20px; border-bottom: 1px solid var(--border-color);
        display: flex; gap: 12px; align-items: center;
        cursor: pointer; transition: background-color 0.2s;
    }
    .notification-item:last-child { border-bottom: none; }
    .notification-item:hover { background-color: rgba(var(--border-color-rgb), 0.2); }
    .notification-item.unread { background-color: rgba(255, 111, 0, 0.1); }
    .notification-icon {
        flex-shrink: 0; width: 36px; height: 36px;
        display: grid; place-items: center;
        border-radius: 50%;
        background-color: var(--bg-tertiary);
    }
    .notification-icon svg { width: 18px; height: 18px; color: var(--text-secondary); }
    .notification-content p { margin: 0 0 4px 0; font-size: 14px; line-height: 1.4; color: var(--text-primary); }
    .notification-content span { font-size: 12px; color: var(--text-secondary); }
    body.notification-backdrop-active::before {
      content: ""; position: fixed; inset: 0;
      background: rgba(0,0,0,0.5); z-index: 109;
    }
    
    @media (max-width: 992px) {
        .charts-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      #main-nav { position: fixed; left: -270px; top: 60px; z-index: 80; box-shadow: 4px 0 15px rgba(0,0,0,.1); }
      #main-nav.open { left: 0; }
      #content { padding: 16px; padding-bottom: 80px; }
      #menu-toggle { display: block !important; }
      #mobile-footer { display: block; }
      #logout-btn span { display: none; }
      #logout-btn { padding: 8px; }
      #notification-dropdown.mobile-active {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 90vw; max-width: 380px;
      }
      .register-fields-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      header { padding: 0 16px; }
      .form-grid { grid-template-columns: 1fr; }
      .kpi-grid { grid-template-columns: 1fr 1fr; }
      .kpi-card p {font-size: 22px; }
      .card { padding: 16px; }
      .active-shift-item { flex-direction: column; align-items: flex-start; gap: 12px; }
      table { font-size: 14px; }
      thead th, tbody td { padding: 12px 8px; }
      .actions { flex-wrap: wrap; gap: 6px; }
      .actions button { padding: 5px 8px; font-size: 13px; }
    }
  </style>
</head>
<body>

  <div id="toast-container"></div>
  <div id="auth-container" class="hidden"></div>

  <div id="app-container" class="hidden">
    <header>
      <button id="menu-toggle" title="Menú" class="button-secondary" style="padding: 8px 10px; display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
      </button>
      <a href="#" class="header-logo" data-view="dashboard-view">
        <svg class="header-logo-icon" viewBox="0 0 120 120">
          <defs><linearGradient id="headerLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="var(--grad-yellow)"/><stop offset="55%" stop-color="var(--grad-orange)"/><stop offset="100%" stop-color="var(--grad-red)"/></linearGradient></defs>
          <g fill="url(#headerLogoGradient)">
            <polygon points="60,10 100,30 60,50 20,30"/><polygon points="100,30 100,70 60,90 60,50"/><polygon points="20,30 60,50 60,90 20,70"/>
          </g>
        </svg>
        <span class="header-logo-text"><span class="header-logo-seb">seb365</span> <span class="header-logo-pro">pro</span></span>
      </a>
      <div class="user-info">
        <button id="theme-toggle" title="Alternar tema" class="button-secondary" style="padding: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </button>
        <div id="notification-bell" class="notification-container">
            <button title="Notificaciones" class="button-secondary" style="padding: 8px; position: relative;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                <span id="notification-counter" class="hidden"></span>
            </button>
            <div id="notification-dropdown" class="hidden">
                <div class="notification-header">
                    <h3>Notificaciones</h3>
                </div>
                <div id="notification-list">
                </div>
            </div>
        </div>
        <button id="profile-btn" title="Mi Perfil" class="button-secondary" style="padding: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </button>
        <button id="logout-btn" class="button-secondary" style="display:flex; align-items:center; gap: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            <span>Salir</span>
        </button>
      </div>
    </header>
    <main>
      <nav id="main-nav">
        <a href="#" class="nav-link" data-view="dashboard-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg><span>Dashboard</span></a>
        <a href="#" class="nav-link" data-view="reports-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg><span>Reportes</span></a>
        <a href="#" class="nav-link" data-view="shifts-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>Turnos y Ventas</span></a>
        <a href="#" class="nav-link" data-view="inventory-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="m3.27 6.96 8.73 5.05 8.73-5.05"/><path d="m12 22.08V12"/></svg><span>Inventario</span></a>
        <a href="#" class="nav-link" data-view="cashflow-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg><span>Flujo de Caja</span></a>
        <a href="#" class="nav-link" data-view="products-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><span>Productos y Fichas</span></a>
        <a href="#" class="nav-link" data-view="providers-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg><span>Proveedores</span></a>
        <a href="#" class="nav-link admin-only" data-view="workers-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Trabajadores</span></a>
        <a href="#" class="nav-link hidden" data-view="profile-view"></a>
      </nav>
      <div id="content"></div>
    </main>
    <footer id="mobile-footer">
        <div id="mobile-footer-nav">
            <a href="#" class="mobile-nav-link" data-view="dashboard-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg><span>Dashboard</span></a>
            <a href="#" class="mobile-nav-link" data-view="reports-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg><span>Reportes</span></a>
            <a href="#" class="mobile-nav-link" data-view="shifts-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>Turnos</span></a>
            <a href="#" class="mobile-nav-link" data-view="inventory-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="m3.27 6.96 8.73 5.05 8.73-5.05"/><path d="m12 22.08V12"/></svg><span>Inventario</span></a>
            <a href="#" class="mobile-nav-link" data-view="cashflow-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg><span>Caja</span></a>
        </div>
    </footer>
  </div>

  <div id="loan-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>Registrar Préstamo</h3><button type="button" class="modal-close-btn">&times;</button></div>
        <form id="loan-form">
            <div class="modal-form-body">
                <input id="loan-description" placeholder="Descripción" required>
                <input id="loan-value" type="number" step="any" min="1" placeholder="Valor" required>
                <button type="submit">Añadir Préstamo</button>
            </div>
        </form>
    </div>
  </div>
 
  <div id="ficha-sale-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="ficha-sale-modal-title">Vender Ficha</h3>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <form id="ficha-sale-form">
            <div class="modal-form-body">
                <input type="hidden" id="ficha-sale-product-id">
                <p>Stock disponible: <strong id="ficha-sale-stock"></strong></p>
                <div>
                    <label for="ficha-sale-quantity">Cantidad a vender:</label>
                    <input id="ficha-sale-quantity" type="number" min="1" required>
                </div>
                <button type="submit">Confirmar Venta</button>
            </div>
        </form>
    </div>
  </div>

  <div id="desglose-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="desglose-modal-title">Desglose del Turno</h3>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div id="desglose-modal-body" class="table-wrapper" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>

  <div id="sales-breakdown-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="sales-breakdown-modal-title">Desglose de Pago por Ventas</h3>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div id="sales-breakdown-modal-body" style="max-height: 60vh; overflow-y: auto;">
            <p>Calculando reporte...</p>
        </div>
    </div>
   </div>
   
  <div id="kpi-breakdown-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="kpi-breakdown-modal-title">Desglose</h3>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div id="kpi-breakdown-modal-body" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
   </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, collectionGroup, doc, setDoc, addDoc, getDoc, getDocs, onSnapshot, query, where, orderBy, serverTimestamp, writeBatch, runTransaction, increment, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Inicialización de Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyDm2g7JwRNwF9Xgktj9ATPkJM8qnss8eNg",
        authDomain: "seb360-pro.firebaseapp.com",
        projectId: "seb360-pro",
        storageBucket: "seb360-pro.appspot.com",
        messagingSenderId: "750401346580",
        appId: "1:750401346580:web:a682fd6ae09292ff589b01"
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);

    // --- Helpers y Estado Global ---
    const tenantId = () => auth.currentUser?.uid;
    const TCOL = (...segs) => collection(db, "tenants", tenantId(), ...segs);
    const TDOC = (...segs) => doc(db, "tenants", tenantId(), ...segs);
    const stockRef = (productId, place) => TDOC("inventory", productId, "stock", place);

    let colref = {};
    function buildColRef() {
      if (!tenantId()) return;
      colref = {
        users: collection(db, "users"),
        products: TCOL("products"),
        providers: TCOL("providers"),
        workers: TCOL("workers"),
        cashflow: TCOL("cashflow_entries"),
        shifts: TCOL("shifts"),
        purchases: TCOL("purchases"),
        notifications: TCOL("notifications")
      };
    }

    let appState = {
      user: null, userData: null, role: null, unsub: [],
      products: [], providers: [], workers: [], notifications: [],
      inventory: {}, cashflow: [],
      activeShifts: [], selectedShiftId: null,
      dashboardData: {},
      reportDataCache: null
    };
    let registrationData = {}, shiftSubListeners = {}, stockUnsubscribers = {};
    const LOW_STOCK_THRESHOLD = 10;

    // --- Funciones de Utilidad ---
    const showToast = (msg, type = "success") => {
      const c = document.getElementById("toast-container");
      const t = document.createElement("div");
      t.className = `toast ${type}`;
      t.textContent = msg;
      c.appendChild(t);
      setTimeout(() => t.remove(), 3200);
    };

    const COP = (v) => new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", maximumFractionDigits: 0 }).format(v);
    const fmtDate = (ts) => ts?.toDate().toLocaleString("es-CO", { hour12: true, day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'}) ?? "—";
    const fmtTime = (ts) => ts?.toDate().toLocaleTimeString("es-CO", { hour: '2-digit', minute: '2-digit', hour12: true }) ?? "—";

    const toUnidades = (qty, unit, prod) => {
        if (!prod) return qty;
        if (unit === "cajas") return qty * (prod.unidadesPorCaja || 1);
        if (unit === "canastas") return qty * (prod.unidadesPorCanasta || 1);
        return qty;
    };
    
    function hexToRgb(hex) {
        let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }

    let raf = null;
    const scheduleRender = (forceId = null) => {
      if (raf) return;
      raf = requestAnimationFrame(() => {
        const activeId = forceId || (document.querySelector(".nav-link.active")?.dataset.view) || "dashboard-view";
        renderView(activeId);
        document.querySelectorAll('.mobile-nav-link').forEach(link => {
            link.classList.toggle('active', link.dataset.view === activeId);
        });
        raf = null;
      });
    };

    // --- Manejadores de Eventos Principales ---
    const mainNav = document.getElementById("main-nav");
    const mobileFooterNav = document.getElementById("mobile-footer-nav");
    
    function handleNavClick(e) {
      const link = e.target.closest(".nav-link, .mobile-nav-link, .header-logo");
      if (!link || !link.dataset.view) return;
      e.preventDefault();
      mainNav.classList.remove("open");
      const viewId = link.dataset.view;
      document.querySelectorAll(".nav-link, .mobile-nav-link").forEach(n => {
        n.classList.toggle('active', n.dataset.view === viewId);
      });
      appState.selectedShiftId = null;
      scheduleRender(viewId);
    }

    mainNav.addEventListener("click", handleNavClick);
    mobileFooterNav.addEventListener("click", handleNavClick);
    document.querySelector('header').addEventListener("click", handleNavClick);
    document.getElementById("menu-toggle").addEventListener("click", () => mainNav.classList.toggle("open"));
    document.getElementById("profile-btn").addEventListener("click", () => document.querySelector('.nav-link[data-view="profile-view"]').click());
    document.getElementById("logout-btn").addEventListener("click", () => signOut(auth));
    
    // --- Lógica de Tema (Claro/Oscuro) ---
    const themeToggleBtn = document.getElementById('theme-toggle');
    const updateThemeToggleIcon = (theme) => {
      const icon = themeToggleBtn.querySelector('svg');
      icon.innerHTML = theme === 'dark'
        ? `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>`
        : `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`;
    };
    
    function applyTheme(theme) {
        document.body.setAttribute('data-theme', theme);
        updateThemeToggleIcon(theme);
        const primaryBG = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim();
        const borderC = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
        const primaryRgb = hexToRgb(primaryBG) || {r: 255, g: 255, b: 255};
        const borderRgb = hexToRgb(borderC) || {r: 224, g: 224, b: 224};
        document.documentElement.style.setProperty('--bg-primary-rgb', `${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b}`);
        document.documentElement.style.setProperty('--border-color-rgb', `${borderRgb.r}, ${borderRgb.g}, ${borderRgb.b}`);
    }

    themeToggleBtn.addEventListener('click', () => {
      const newTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', newTheme);
      applyTheme(newTheme);
      const activeView = document.querySelector(".nav-link.active")?.dataset.view;
      if (activeView === 'dashboard-view') {
        updateDashboardData();
      }
    });
    
    const savedTheme = localStorage.getItem('theme');
    const initialTheme = savedTheme || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(initialTheme);


    // --- Flujo de Autenticación ---
    const authContainer = document.getElementById("auth-container");
    const ICONS = {
        eye: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
        eyeOff: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" y1="2" x2="22" y2="22"></line></svg>`
    };

    function renderAuthUI(view = 'login') {
        const loginActive = view === 'login';
        authContainer.innerHTML = `
        <div class="auth-box">
            <a href="#" class="header-logo" style="justify-content: center; text-decoration: none;">
                <svg class="header-logo-icon" viewBox="0 0 120 120" style="width: 36px; height: 36px;">
                  <defs><linearGradient id="authLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="var(--grad-yellow)"/><stop offset="55%" stop-color="var(--grad-orange)"/><stop offset="100%" stop-color="var(--grad-red)"/></linearGradient></defs>
                  <g fill="url(#authLogoGradient)"><polygon points="60,10 100,30 60,50 20,30"/><polygon points="100,30 100,70 60,90 60,50"/><polygon points="20,30 60,50 60,90 20,70"/></g>
                </svg>
                <span class="header-logo-text"><span class="header-logo-seb">seb365</span> <span class="header-logo-pro">pro</span></span>
            </a>
            
            <div id="login-view" class="${loginActive ? '' : 'hidden'}">
                <h2>Bienvenido de Nuevo</h2>
                <p>Ingresa tus credenciales para continuar.</p>
                <form id="login-form" autocomplete="on">
                    <div class="auth-form-fields">
                        <input type="email" id="login-email" placeholder="Correo electrónico" required>
                        <div class="password-wrapper">
                            <input type="password" id="login-password" placeholder="Contraseña" required>
                            <button type="button" class="password-toggle-btn" title="Mostrar/Ocultar contraseña">${ICONS.eye}</button>
                        </div>
                    </div>
                    <button type="submit">Ingresar</button>
                    <div class="divider">o</div>
                    <button id="google-login-btn" type="button" class="button-secondary" style="display:flex;justify-content:center;align-items:center;"><svg viewBox="0 0 48 48" style="width:18px;height:18px;margin-right:8px;"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg><span>Entrar con Google</span></button>
                </form>
                <p style="margin-top:20px; font-size: 14px;">¿No tienes cuenta? <a href="#" id="show-register-link" class="auth-switch-link">Crea una ahora</a></p>
            </div>

            <div id="register-view" class="${loginActive ? 'hidden' : ''}">
                <h2>Crea tu Cuenta</h2>
                <p>Completa el formulario para empezar a gestionar tu negocio.</p>
                <form id="register-form" autocomplete="on">
                    <div class="auth-form-fields">
                         <input type="text" id="register-name" placeholder="Nombre completo" required>
                         <input type="email" id="register-email" placeholder="Correo electrónico" required>
                        <div class="register-fields-grid">
                            <input type="tel" id="register-phone" placeholder="Teléfono" required>
                            <input type="text" id="register-business-name" placeholder="Nombre del negocio" required>
                        </div>
                        <select id="register-business-type" required><option value="">Tipo de negocio...</option><option value="bar">Bar</option><option value="discoteca">Discoteca</option><option value="cafeteria">Cafetería</option><option value="restaurante">Restaurante</option></select>
                        <div class="register-fields-grid">
                            <div class="password-wrapper">
                                <input type="password" id="register-password" placeholder="Contraseña" required>
                                <button type="button" class="password-toggle-btn" title="Mostrar/Ocultar contraseña">${ICONS.eye}</button>
                            </div>
                            <div class="password-wrapper">
                                <input type="password" id="register-password-confirm" placeholder="Confirmar" required>
                                <button type="button" class="password-toggle-btn" title="Mostrar/Ocultar contraseña">${ICONS.eye}</button>
                            </div>
                        </div>
                    </div>
                    <button type="submit">Crear Cuenta</button>
                </form>
                 <p style="margin-top:20px; font-size: 14px;">¿Ya tienes cuenta? <a href="#" id="show-login-link" class="auth-switch-link">Inicia sesión</a></p>
            </div>
        </div>`;

        document.getElementById("login-form").addEventListener("submit", async (e) => { e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.disabled=true; signInWithEmailAndPassword(auth, document.getElementById("login-email").value, document.getElementById("login-password").value).catch(err=>showToast(err.message,"error")).finally(()=>{btn.disabled=false;}); });
        document.getElementById("google-login-btn").addEventListener("click", async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(err) { showToast(err.message, "error"); } });
        document.getElementById("register-form").addEventListener("submit", async (e) => { 
            e.preventDefault(); 
            const password = document.getElementById("register-password").value;
            const confirmPassword = document.getElementById("register-password-confirm").value;
            if (password.length < 6) {
                showToast("La contraseña debe tener al menos 6 caracteres.", "error"); return;
            }
            if (password !== confirmPassword) {
                showToast("Las contraseñas no coinciden.", "error"); return;
            }

            const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
            const regData = {
                displayName: document.getElementById("register-name").value,
                phone: document.getElementById("register-phone").value,
                email: document.getElementById("register-email").value,
                password: password,
                businessName: document.getElementById("register-business-name").value,
                businessType: document.getElementById("register-business-type").value
            };
            
            try { 
                const cred = await createUserWithEmailAndPassword(auth, regData.email, regData.password); 
                const batch = writeBatch(db);
                const userRef = doc(db, "users", cred.user.uid);
                batch.set(userRef, { 
                    email: regData.email, 
                    displayName: regData.displayName,
                    createdAt: serverTimestamp()
                });
                const tenantRef = doc(db, "tenants", cred.user.uid);
                batch.set(tenantRef, {
                    ownerName: regData.displayName,
                    ownerEmail: regData.email,
                    phone: regData.phone,
                    businessName: regData.businessName,
                    businessType: regData.businessType,
                    role: "admin",
                    active: true,
                    createdAt: serverTimestamp()
                });
                await batch.commit();
                showToast("Cuenta creada exitosamente"); 
            } catch(err) { 
                showToast(err.message, "error"); 
            } finally { 
                btn.disabled = false; 
            } 
        });
        document.getElementById("show-register-link").addEventListener("click", (e) => { e.preventDefault(); renderAuthUI('register'); });
        document.getElementById("show-login-link").addEventListener("click", (e) => { e.preventDefault(); renderAuthUI('login'); });
        authContainer.addEventListener('click', (e) => {
            const toggleBtn = e.target.closest('.password-toggle-btn');
            if (toggleBtn) {
                const passwordInput = toggleBtn.closest('.password-wrapper').querySelector('input');
                passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
                toggleBtn.innerHTML = passwordInput.type === 'password' ? ICONS.eye : ICONS.eyeOff;
            }
        });
    }
    
    let persistentHandlersAttached = false;
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        buildColRef();
        const tenantDocRef = doc(db, "tenants", user.uid);
        const tenantDoc = await getDoc(tenantDocRef);
        appState.user = user;
        appState.userData = tenantDoc.exists() ? tenantDoc.data() : { email: user.email };
        appState.role = appState.userData.role || "admin";
        document.body.dataset.role = appState.role;
        document.getElementById("auth-container").classList.add("hidden");
        document.getElementById("app-container").classList.remove("hidden");
        document.querySelector('.nav-link[data-view="dashboard-view"]').classList.add("active");
        if (!persistentHandlersAttached) {
          attachPersistentHandlers();
          persistentHandlersAttached = true;
        }
        initRealtime();
        scheduleRender("dashboard-view");
      } else {
        appState.unsub.forEach(u => { if(typeof u === 'function') u() });
        Object.values(stockUnsubscribers).forEach(unsubArray => unsubArray.forEach(unsub => { if(typeof unsub === 'function') unsub() }));
        Object.values(shiftSubListeners).forEach(unsubArray => unsubArray.forEach(unsub => { if(typeof unsub === 'function') unsub() }));
        stockUnsubscribers = {};
        shiftSubListeners = {};
        appState = { user: null, userData: null, role: null, unsub: [], products: [], providers: [], workers: [], notifications: [], inventory: {}, cashflow: [], activeShifts: [], selectedShiftId: null, dashboardData: {}, reportDataCache: null };
        document.getElementById("app-container").classList.add("hidden");
        document.getElementById("auth-container").classList.remove("hidden");
        renderAuthUI('login');
        persistentHandlersAttached = false;
      }
    });

    function initRealtime(){
      if(!tenantId()) return;
      appState.unsub.forEach(u=> { if(typeof u === 'function') u() }); 
      appState.unsub=[];
      
      Object.values(stockUnsubscribers).forEach(unsubArray => unsubArray.forEach(unsub => { if(typeof unsub === 'function') unsub() }));
      stockUnsubscribers = {};

      const add = (un)=> appState.unsub.push(un);

      add(onSnapshot(query(colref.products, orderBy("nombre")), (snapshot) => {
          appState.products = snapshot.docs.map(d => ({id:d.id, ...d.data()}));
          const newProductIds = new Set(appState.products.map(p => p.id));
          for (const productId in stockUnsubscribers) {
              if (!newProductIds.has(productId)) {
                  stockUnsubscribers[productId].forEach(unsub => unsub());
                  delete stockUnsubscribers[productId];
                  delete appState.inventory[productId];
              }
          }
          appState.products.forEach(product => {
              if (!stockUnsubscribers[product.id]) {
                  const unsubBodega = onSnapshot(stockRef(product.id, 'bodega'), (docSnap) => {
                      if (!appState.inventory[product.id]) appState.inventory[product.id] = {};
                      appState.inventory[product.id].bodega = docSnap.data() || { unidades: 0 };
                      scheduleRender();
                  });
                  const unsubBarra = onSnapshot(stockRef(product.id, 'barra'), (docSnap) => {
                      if (!appState.inventory[product.id]) appState.inventory[product.id] = {};
                      appState.inventory[product.id].barra = docSnap.data() || { unidades: 0 };
                      scheduleRender();
                  });
                  stockUnsubscribers[product.id] = [unsubBodega, unsubBarra];
              }
          });
          scheduleRender();
      }));

      add(onSnapshot(query(colref.providers, orderBy("nombre")), s=>{ appState.providers = s.docs.map(d=>({id:d.id, ...d.data()})); scheduleRender(); }));
      add(onSnapshot(query(colref.workers, orderBy("nombre")), s=>{ appState.workers = s.docs.map(d=>({id:d.id, ...d.data()})); scheduleRender(); }));
      add(onSnapshot(query(colref.cashflow, orderBy("date","desc")), s=>{ appState.cashflow = s.docs.map(d=>({id:d.id, ...d.data()})); scheduleRender(); }));
      add(onSnapshot(query(colref.notifications, orderBy("timestamp", "desc")), s => {
            appState.notifications = s.docs.map(d => ({id: d.id, ...d.data()}));
            renderNotifications();
      }));
      add(onSnapshot(query(colref.shifts, where("estado", "==", "abierto")), (snapshot) => {
        const currentShiftIds = snapshot.docs.map(doc => doc.id);
        const previousShiftIds = appState.activeShifts.map(shift => shift.id);
        previousShiftIds.forEach(shiftId => {
            if (!currentShiftIds.includes(shiftId) && shiftSubListeners[shiftId]) {
                shiftSubListeners[shiftId].forEach(unsub => unsub());
                delete shiftSubListeners[shiftId];
            }
        });
        const shiftsData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        shiftsData.forEach((shiftData) => {
            const existingShiftIndex = appState.activeShifts.findIndex(s => s.id === shiftData.id);
            if (existingShiftIndex === -1) {
                const newShift = { ...shiftData, sales: [], loans: [] };
                appState.activeShifts.push(newShift);
                const salesUnsub = onSnapshot(
                  collection(db, "tenants", tenantId(), "shifts", shiftData.id, "sales"),
                  (salesSnapshot) => {
                      const shiftToUpdate = appState.activeShifts.find(s => s.id === shiftData.id);
                      if(shiftToUpdate) shiftToUpdate.sales = salesSnapshot.docs.map(d => ({id:d.id, ...d.data()}));
                      scheduleRender();
                  }
                );
                const loansUnsub = onSnapshot(
                  collection(db, "tenants", tenantId(), "shifts", shiftData.id, "loans"),
                  (loansSnapshot) => {
                      const shiftToUpdate = appState.activeShifts.find(s => s.id === shiftData.id);
                      if(shiftToUpdate) shiftToUpdate.loans = loansSnapshot.docs.map(d => ({id:d.id, ...d.data()}));
                      scheduleRender();
                  }
                );
                shiftSubListeners[shiftData.id] = [salesUnsub, loansUnsub];
            } else {
                // Update existing shift data without touching subcollections
                appState.activeShifts[existingShiftIndex] = { ...appState.activeShifts[existingShiftIndex], ...shiftData };
            }
        });
        appState.activeShifts = appState.activeShifts.filter(s => currentShiftIds.includes(s.id));
        scheduleRender();
      }));
    }

    const content = document.getElementById("content");
    const row = (cols)=> `<tr>${cols.map(c=>`<td>${c}</td>`).join("")}</tr>`;
    
    function renderView(id) {
        let html = "";
        if (id === 'dashboard-view') {
            html = `<div class="content-view">
                <h2>Dashboard</h2>
                <div class="kpi-grid">
                    <div class="card kpi-card" data-kpi="inventory-value">
                        <h3>Valor Total del Inventario</h3>
                        <p id="db-kpi-inventory-value" style="color: var(--accent-blue);">${COP(0)}</p>
                    </div>
                     <div class="card kpi-card" data-kpi="gross-sales">
                        <h3>Ventas Brutas (Hoy)</h3>
                        <p id="db-kpi-gross-sales" class="amount-positive">${COP(0)}</p>
                    </div>
                    <div class="card kpi-card" data-kpi="total-costs">
                        <h3>Costos Totales (Hoy)</h3>
                        <p id="db-kpi-total-costs" class="amount-negative">${COP(0)}</p>
                    </div>
                    <div class="card kpi-card" data-kpi="net-profit">
                        <h3>Ganancia Neta (Hoy)</h3>
                        <p id="db-kpi-net-profit">${COP(0)}</p>
                    </div>
                    <div class="card kpi-card" data-kpi="low-stock">
                        <h3>Productos Bajo Stock</h3>
                        <p id="db-kpi-low-stock" style="color: var(--accent-yellow-tag);">0</p>
                    </div>
                    <div class="card kpi-card" data-kpi="provider-balance">
                        <h3>Saldo Proveedores</h3>
                        <p id="db-kpi-provider-balance" class="amount-negative">${COP(0)}</p>
                    </div>
                    <div class="card kpi-card" data-kpi="active-loans">
                        <h3>Préstamos Activos</h3>
                        <p id="db-kpi-active-loans">${COP(0)}</p>
                    </div>
                    <div class="card kpi-card" data-kpi="average-ticket">
                        <h3>Ticket Promedio (Hoy)</h3>
                        <p id="db-kpi-average-ticket">${COP(0)}</p>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h3>Ingresos por Hora (Últimas 24h)</h3>
                            <div id="bar-chart-container"></div>
                        </div>
                        <div class="chart-container">
                            <h3>Top 5 Productos (Hoy)</h3>
                            <div id="donut-chart-container"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Estado de Inventario General</h2>
                    <div class="table-wrapper" style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Stock Bodega</th>
                                    <th>Stock Barra</th>
                                    <th>Total</th>
                                    <th>Valor Total</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-status-table">
                                <tr><td colspan="6">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        }
        if (id === 'reports-view') {
            html = `<div class="content-view">
                <h2>Generador de Reportes</h2>
                <div class="card" style="margin-bottom: 24px;">
                    <form id="reports-form" class="form-grid" style="align-items: flex-end; gap: 16px 24px;">
                        <div>
                            <label for="report-start-date">Fecha de Inicio</label>
                            <input type="datetime-local" id="report-start-date" required>
                        </div>
                        <div>
                            <label for="report-end-date">Fecha de Fin</label>
                            <input type="datetime-local" id="report-end-date" required>
                        </div>
                        <button type="submit">Generar Reporte</button>
                    </form>
                </div>
                <div id="report-output">
                    <p style="text-align: center; color: var(--text-secondary);">Selecciona un rango de fechas para generar un reporte.</p>
                </div>
            </div>`;
        }
        if (id === 'products-view') {
            const providersPorVentas = appState.providers.filter(p => p.tipoPago === 'porVentas');
            const providerOpts = providersPorVentas.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            const rows = appState.products.map(p => row([ p.nombre, p.esFicha ? 'Sí' : 'No', COP(p.precioVenta || 0), COP(p.precioComision || 0), `<div class="actions"><button class="btn-edit" data-id="${p.id}">Editar</button></div>` ])).join("");
            html = `<div class="content-view"><h2>Productos y Fichas</h2><form id="product-form" class="card"><input type="hidden" id="product-id"><div class="form-grid"><div><label for="product-nombre">Nombre</label><input id="product-nombre" placeholder="Nombre" required></div><div><label for="product-precioVenta">Precio Venta</label><input id="product-precioVenta" type="number" step="any" min="0" placeholder="Precio Venta" required></div><div><label for="product-precioCompra">Precio Compra</label><input id="product-precioCompra" type="number" step="any" min="0" placeholder="Precio Compra" required></div><div><label for="product-precioComision">Valor para Pago (Comisión)</label><input id="product-precioComision" type="number" step="any" min="0" placeholder="Valor para Pago (Comisión)"></div><div><label for="product-unidadesPorCaja">Unidades por Caja</label><input id="product-unidadesPorCaja" type="number" min="1" placeholder="Unid. por Caja"></div><div><label for="product-unidadesPorCanasta">Unidades por Canasta</label><input id="product-unidadesPorCanasta" type="number" min="1" placeholder="Unid. por Canasta"></div></div><div id="provider-por-ventas-wrapper" style="margin-top: 16px;">
            <label for="product-providerPorVentas">Proveedor para Pago por Ventas (Opcional)</label>
            <select id="product-providerPorVentas"><option value="">Ninguno</option>${providerOpts}</select>
            </div><div style="margin-top: 16px;"><label style="display:inline-flex; align-items:center; gap: 8px; font-size: 16px;"><input id="product-esFicha" type="checkbox"> Es una Ficha</label></div><button type="submit" style="margin-top: 16px;">Guardar</button></form><div class="table-wrapper" style="margin-top:24px"><table><thead><tr><th>Nombre</th><th>Es Ficha</th><th>P. Venta</th><th>Valor Pago</th><th>Acciones</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
        }
        if (id === 'inventory-view') {
            const rows = appState.products.map(p=> row([ p.nombre, appState.inventory[p.id]?.bodega?.unidades ?? 0, appState.inventory[p.id]?.barra?.unidades ?? 0 ])).join("");
            const productOpts = appState.products.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join("");
            const providerOpts = appState.providers.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join("");
            html = `<div class="content-view"><h2>Inventario y Compras</h2><div class="form-grid"><form id="purchase-form" class="card"><h3>Registrar Compra</h3><div style="display: flex; flex-direction: column; gap: 12px;"><select id="purchase-provider" required><option value="">Proveedor…</option>${providerOpts}</select><div id="provider-payment-type-display" style="margin-top: -4px; margin-bottom: -4px; padding: 10px; background-color: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-color); display: none;"><span style="color: var(--text-secondary); font-size: 14px;">Tipo de Pago: </span><strong style="font-weight: 500;"></strong></div><select id="purchase-product" required><option value="">Producto…</option>${productOpts}</select><input id="purchase-quantity" type="number" min="1" placeholder="Cantidad" required><select id="purchase-unit" required><option value="unidades">Unidades</option><option value="cajas">Cajas</option><option value="canastas">Canastas</option></select><button type="submit">Registrar Compra</button></div></form><form id="transfer-form" class="card"><h3>Trasladar Bodega → Barra</h3><div style="display: flex; flex-direction: column; gap: 12px;"><select id="transfer-product" required><option value="">Producto…</option>${productOpts}</select><input id="transfer-quantity" type="number" min="1" placeholder="Cantidad" required><select id="transfer-unit" required><option value="unidades">Unidades</option><option value="cajas">Cajas</option><option value="canastas">Canastas</option></select><button type="submit">Trasladar</button></div></form></div><h3 style="margin:24px 0 12px 0;">Stock Actual</h3><div class="table-wrapper"><table><thead><tr><th>Producto</th><th>Stock Bodega</th><th>Stock Barra</th></tr></thead><tbody>${rows || `<tr><td colspan="3">Sin stock.</td></tr>`}</tbody></table></div></div>`;
        }
        if (id === 'cashflow-view') {
            const rows = appState.cashflow.map(e=>`<tr><td>${fmtDate(e.date)}</td><td>${e.description}</td><td class="${e.type==="ingreso"?"amount-positive":"amount-negative"}" style="font-weight: 500;">${COP(e.type==="ingreso"?e.amount:-e.amount)}</td></tr>`).join("");
            html = `<div class="content-view"><h2>Flujo de Caja</h2><form id="cashflow-form" class="card"><div class="form-grid" style="align-items: flex-end;"><select id="cashflow-type" required><option value="ingreso">Ingreso</option><option value="egreso">Egreso</option></select><input id="cashflow-amount" type="number" step="any" min="1" placeholder="Monto" required></div><input id="cashflow-description" placeholder="Descripción" required style="margin: 12px 0;"><button type="submit">Registrar</button></form><h3 style="margin:24px 0 12px 0;">Historial</h3><div class="table-wrapper"><table><thead><tr><th>Fecha</th><th>Descripción</th><th>Monto</th></tr></thead><tbody>${rows || `<tr><td colspan="3">Sin movimientos.</td></tr>`}</tbody></table></div></div>`;
        }
        if (id === 'providers-view') {
            const getTipoPagoText = (tipo) => {
                if (tipo === 'porVentas') return 'Por Ventas';
                if (tipo === 'consignacion') return 'Consignación';
                return 'Contado';
            };
            const rows = appState.providers.map(p => {
                const actions = `<div class="actions"><button class="btn-edit-provider" data-id="${p.id}">Editar</button>${p.tipoPago === 'porVentas' ? `<button class="btn-view-sales-breakdown button-secondary" data-id="${p.id}">Desglose</button>` : ''}<button class="btn-settle" data-id="${p.id}">Liquidar</button></div>`;
                return row([p.nombre, getTipoPagoText(p.tipoPago), COP(p.saldoPendiente || 0), actions]);
            }).join("");

            html = `<div class="content-view"><h2>Proveedores</h2><form id="provider-form" class="card ${appState.role==="admin"?"":"hidden"}"><input type="hidden" id="provider-id"><div class="form-grid" style="margin-bottom: 12px; align-items: end;"><div><label for="provider-nombre">Nombre del proveedor</label><input id="provider-nombre" placeholder="Nombre del proveedor" required></div><div><label for="provider-contacto">Contacto</label><input id="provider-contacto" placeholder="Contacto"></div><div><label for="provider-tipoPago">Tipo de Pago</label><select id="provider-tipoPago"><option value="contado">Contado</option><option value="consignacion">Consignación</option><option value="porVentas">Por Ventas</option></select></div></div><button type="submit">Guardar Proveedor</button></form><div id="settlement-details" class="hidden card" style="margin-top:12px; border-left: 4px solid var(--brand-primary);"><h4>Liquidar a: <span id="settlement-provider-name"></span></h4><p>Saldo: <strong id="settlement-provider-balance"></strong></p><button id="settle-provider-btn">Pagar y Registrar Egreso</button></div><h3 style="margin:24px 0 12px 0;">Lista</h3><div class="table-wrapper"><table><thead><tr><th>Nombre</th><th>Tipo de Pago</th><th>Saldo</th><th>Acciones</th></tr></thead><tbody>${rows || `<tr><td colspan="4">Sin proveedores.</td></tr>`}</tbody></table></div></div>`;
        }
        if (id === 'workers-view') {
            const rows = appState.workers.map(w=> row([ w.nombre, COP(w.pagoBase||0), (w.activo?"✅":"❌"), `<div class="actions"><button class="btn-edit-worker" data-id="${w.id}">Editar</button></div>` ])).join("");
            html = `<div class="content-view"><h2>Trabajadores</h2><form id="worker-form" class="card"><input type="hidden" id="worker-id"><div class="form-grid" style="margin-bottom: 12px;"><input id="worker-nombre" placeholder="Nombre completo" required><input id="worker-pagoBase" type="number" step="any" min="0" placeholder="Pago base (opcional)"></div><label style="display:inline-flex; align-items:center; gap: 8px;"><input id="worker-activo" type="checkbox" checked> Activo</label><button type="submit">Guardar Trabajador</button></form><h3 style="margin:24px 0 12px 0;">Lista</h3><div class="table-wrapper"><table><thead><tr><th>Nombre</th><th>Pago Base</th><th>Activo</th><th>Acciones</th></tr></thead><tbody>${rows || `<tr><td colspan="4">Sin trabajadores.</td></tr>`}</tbody></table></div></div>`;
        }
        if (id === 'profile-view') {
            const u = appState.userData || {};
            html = `<div class="content-view"><h2>Mi Perfil</h2><div class="form-grid"><div class="card"><h2>Datos Personales</h2><form id="profile-personal-form"><div class="form-grid" style="gap: 12px; margin-bottom: 12px;"><div><label for="profile-name">Nombre</label><input id="profile-name" value="${u.ownerName || ''}"></div><div><label for="profile-phone">Teléfono</label><input id="profile-phone" type="tel" value="${u.phone || ''}"></div></div><label for="profile-email">Correo (no se puede cambiar)</label><input id="profile-email" type="email" value="${u.ownerEmail || ''}" disabled><button type="submit" style="margin-top: 16px;">Guardar Datos Personales</button></form></div><div class="card"><h2>Datos del Negocio</h2><form id="profile-business-form"><div style="margin-bottom: 12px;"><label for="profile-business-name">Nombre del Negocio</label><input id="profile-business-name" value="${u.businessName || ''}"></div><div style="margin-bottom: 12px;"><label for="profile-business-type">Tipo de Negocio</label><select id="profile-business-type"><option value="bar" ${u.businessType === 'bar' ? 'selected' : ''}>Bar</option><option value="discoteca" ${u.businessType === 'discoteca' ? 'selected' : ''}>Discoteca</option><option value="cafeteria" ${u.businessType === 'cafeteria' ? 'selected' : ''}>Cafetería</option><option value="restaurante" ${u.businessType === 'restaurante' ? 'selected' : ''}>Restaurante</option></select></div><button type="submit" style="margin-top: 16px;">Guardar Datos del Negocio</button></form></div></div><div class="card" style="margin-top: 24px;"><h2>Licencia</h2><p><strong>Tipo de plan:</strong> PRO</p><p><strong>Estado:</strong> Activa</p><p style="color: var(--text-secondary);">Esta sección se habilitará en futuras actualizaciones.</p></div></div>`;
        }
        if (id === 'shifts-view') {
            if (appState.selectedShiftId) {
                const shift = appState.activeShifts.find(s => s.id === appState.selectedShiftId);
                if (!shift) { appState.selectedShiftId = null; return renderView('shifts-view'); }
                const worker = appState.workers.find(w => w.id === shift.workerId);
                const ingresos = shift.sales.reduce((s, x) => s + x.totalVenta, 0);
                const comisiones = shift.sales.reduce((s, x) => s + (x.totalComision || 0), 0);
                const prestamos = shift.loans.reduce((s, l) => s + l.valor, 0);
                const fichaProducts = appState.products.filter(p => p.esFicha);
                const fichaCardsHTML = fichaProducts.map(ficha => {
                    const stock = appState.inventory[ficha.id]?.barra?.unidades ?? 0;
                    return `<div class="ficha-card" data-product-id="${ficha.id}"><h4>${ficha.nombre}</h4><div class="ficha-card-stock">${stock} <span>uds.</span></div></div>`;
                }).join("");
                html = `<div class="content-view">
                    <button id="back-to-shifts-list" class="button-secondary" style="margin-bottom: 24px;">&larr; Volver a la lista de turnos</button>
                    <h2>Gestionando Turno: <span style="color: var(--brand-primary);">${worker?.nombre || "…"}</span></h2>
                    <h3 style="margin-top: 24px;">Vender Fichas</h3>
                    <div id="fichas-grid">${fichaCardsHTML || "<p>No hay fichas activas configuradas.</p>"}</div>
                    <div class="card" style="margin-top:24px">
                        <h4>Resumen del Turno</h4>
                        <p><strong>Ingresos (Ventas):</strong> ${COP(ingresos)}</p>
                        <p><strong>Total para Pago (Comisiones):</strong> ${COP(comisiones)}</p>
                        <p><strong>Préstamos:</strong> ${COP(prestamos)}</p>
                        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 16px 0;">
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button id="open-loan-modal-btn" class="button-secondary">Registrar Préstamo</button>
                            <button id="close-shift-btn" data-shift-id="${shift.id}" style="background: var(--accent-red); flex-grow: 1;">Cerrar y Liquidar Turno</button>
                        </div>
                    </div>
                </div>`;
            } else {
                const workerOpts = appState.workers.filter(w => w.activo && !appState.activeShifts.some(s => s.workerId === w.id)).map(w => `<option value="${w.id}">${w.nombre}</option>`).join("");
                const activeShiftsHTML = appState.activeShifts.map(shift => {
                    const worker = appState.workers.find(w => w.id === shift.workerId);
                    return `<div class="active-shift-item">
                        <div class="active-shift-item-info"><strong>${worker?.nombre || 'Desconocido'}</strong><span>Inició: ${fmtDate(shift.inicio)}</span></div>
                        <div class="active-shift-item-actions">
                            <button class="btn-view-desglose button-secondary" data-shift-id="${shift.id}">Ver Desglose</button>
                            <button class="btn-manage-shift" data-shift-id="${shift.id}">Gestionar</button>
                        </div>
                    </div>`;
                }).join("");
                html = `<div class="content-view">
                    <h2>Turnos y Ventas</h2>
                    <div class="card"><h3>Iniciar Nuevo Turno</h3><form id="open-shift-form"><select id="shift-worker" required style="margin-bottom: 12px;"><option value="">Seleccionar trabajador…</option>${workerOpts}</select><button type="submit">Iniciar Turno</button></form></div>
                    <h3 style="margin: 24px 0 12px 0;">Turnos Activos (${appState.activeShifts.length})</h3>
                    <div class="active-shifts-list">${activeShiftsHTML || "<p>No hay turnos activos en este momento.</p>"}</div>
                </div>`;
            }
        }
        if (html) { 
            content.innerHTML = html; 
            attachHandlers(id); 
            renderNotifications();
        }
    }
    
    function attachPersistentHandlers() {
        const fichaSaleForm = document.getElementById("ficha-sale-form");
        if(fichaSaleForm) fichaSaleForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const modal = document.getElementById("ficha-sale-modal");
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            const productId = document.getElementById("ficha-sale-product-id").value;
            const unidades = parseInt(document.getElementById("ficha-sale-quantity").value);
            
            if (isNaN(unidades) || unidades <= 0) { 
                showToast("Cantidad inválida", "error"); 
                btn.disabled = false; 
                return; 
            }

            try {
                await runTransaction(db, async (t) => {
                    const productRef = doc(colref.products, productId);
                    const barraRef = stockRef(productId, "barra");
                    const ventaRef = doc(TCOL("shifts", appState.selectedShiftId, "sales"));
                    
                    const productDoc = await t.get(productRef);
                    const stockSnap = await t.get(barraRef);

                    if (!productDoc.exists()) {
                        throw new Error("El producto ya no existe.");
                    }
                    const prod = productDoc.data();
                    const currentStock = stockSnap.data()?.unidades || 0;
                    
                    if (currentStock < unidades) { 
                        throw new Error(`Stock insuficiente para ${prod.nombre}. Solo hay ${currentStock}.`); 
                    }
                    
                    const newStock = currentStock - unidades;
                    t.set(barraRef, { tenantId: tenantId(), unidades: newStock }, { merge: true });

                    t.set(ventaRef, {
                        type: 'ficha', productId: productId, unidades: unidades,
                        totalVenta: unidades * (prod.precioVenta || 0), totalComision: unidades * (prod.precioComision || 0),
                        fecha: serverTimestamp(),
                        tenantId: tenantId()
                    });

                    if (prod.providerPorVentasId) {
                        const costoVenta = unidades * (prod.precioCompra || 0);
                        if (costoVenta > 0) {
                            const providerRef = doc(colref.providers, prod.providerPorVentasId);
                            t.update(providerRef, { saldoPendiente: increment(costoVenta) });
                        }
                    }
                });
                
                const currentShift = appState.activeShifts.find(s => s.id === appState.selectedShiftId);
                const worker = appState.workers.find(w => w.id === currentShift?.workerId);
                const prod = appState.products.find(p => p.id === productId);
                await createNotification(`Venta de ${unidades} x ${prod.nombre} por ${worker?.nombre || 'Desconocido'}.`, 'sale');
                await checkAndNotifyLowStock(productId);
                showToast("Venta registrada");
                modal.classList.remove("visible");

            } catch(err) { 
                showToast(err.message, "error"); 
            } finally { 
                btn.disabled = false; 
            }
        });

        const loanForm = document.getElementById("loan-form");
        if (loanForm) loanForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!appState.selectedShiftId) return;
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            
            const valor = parseFloat(document.getElementById("loan-value").value);
            const desc = document.getElementById("loan-description").value;
            if (isNaN(valor) || !desc) {
                btn.disabled = false;
                return;
            }

            try {
                await addDoc(TCOL("shifts", appState.selectedShiftId, "loans"), { descripcion: desc, valor, fecha: serverTimestamp() });
                
                const currentShift = appState.activeShifts.find(s => s.id === appState.selectedShiftId);
                const worker = appState.workers.find(w => w.id === currentShift?.workerId);
                await createNotification(`${worker?.nombre || 'Alguien'} ha registrado un préstamo.`, 'loan');
                
                loanForm.reset();
                document.getElementById("loan-modal").classList.remove("visible");
            } catch(err) {
                 showToast(err.message, "error");
            } finally {
                btn.disabled = false;
            }
        });

        const notificationBell = document.getElementById('notification-bell');
        const notificationDropdown = document.getElementById('notification-dropdown');

        const toggleNotifications = async () => {
          const isVisible = !notificationDropdown.classList.contains('hidden');
          
          if (isVisible) {
              notificationDropdown.classList.add('hidden');
              notificationDropdown.classList.remove('mobile-active');
              document.body.classList.remove('notification-backdrop-active');
          } else {
              notificationDropdown.classList.remove('hidden');
              if (window.innerWidth <= 768) {
                  notificationDropdown.classList.add('mobile-active');
                  document.body.classList.add('notification-backdrop-active');
              }
              const unreadNotifs = appState.notifications.filter(n => !n.read);
              if (unreadNotifs.length > 0) {
                  const batch = writeBatch(db);
                  unreadNotifs.forEach(notif => {
                      const notifRef = doc(colref.notifications, notif.id);
                      batch.update(notifRef, { read: true });
                  });
                  await batch.commit().catch(console.error);
              }
          }
        };

        notificationBell.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleNotifications();
        });

        document.addEventListener('click', (e) => {
            if (notificationDropdown.classList.contains('hidden')) return;

            const clickedOnBell = notificationBell.contains(e.target);
            const clickedOnDropdown = notificationDropdown.contains(e.target);

            if (!clickedOnBell && !clickedOnDropdown) {
              toggleNotifications();
            }
        });
    }

    async function createNotification(message, type = 'info') {
        try {
            await addDoc(colref.notifications, {
                message: message,
                timestamp: serverTimestamp(),
                read: false,
                type: type
            });
        } catch (error) {
            console.error("Error creating notification:", error);
        }
    }

    async function checkAndNotifyLowStock(productId) {
        const stockData = appState.inventory[productId];
        const product = appState.products.find(p => p.id === productId);
        if (!stockData || !product) return;

        // BUG FIX: Calculate total stock from both bodega and barra
        const totalStock = (stockData.barra?.unidades || 0) + (stockData.bodega?.unidades || 0);
        
        const existingNotif = appState.notifications.find(n => 
            !n.read && n.message.includes(product.nombre) && n.message.includes("Stock bajo")
        );

        if (totalStock <= LOW_STOCK_THRESHOLD && !existingNotif) {
            await createNotification(`Stock bajo: ${product.nombre} solo tiene ${totalStock} unidades en total.`, 'stock');
        }
    }

    function renderNotifications() {
        const counter = document.getElementById('notification-counter');
        const list = document.getElementById('notification-list');
        if (!counter || !list) return;

        const unreadCount = appState.notifications.filter(n => !n.read).length;
        if (unreadCount > 0) {
            counter.textContent = unreadCount;
            counter.classList.remove('hidden');
        } else {
            counter.classList.add('hidden');
        }

        if (appState.notifications.length === 0) {
            list.innerHTML = `<div class="notification-item" style="justify-content: center;"><p>No hay notificaciones.</p></div>`;
            return;
        }

        const ICONS_NOTIF = {
            sale: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10" /><path d="M12 2a10 10 0 1 0-10 10" /><path d="M12 2v20" /><path d="M12 2a10 10 0 1 0 10 10" /><path d="M2 12h20" /></svg>`,
            purchase: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>`,
            stock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`,
            shift: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            loan: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`
        };

        list.innerHTML = appState.notifications.map(n => {
            const icon = ICONS_NOTIF[n.type] || ICONS_NOTIF['sale'];
            return `
                <div class="notification-item ${n.read ? '' : 'unread'}">
                    <div class="notification-icon">${icon}</div>
                    <div class="notification-content">
                        <p>${n.message}</p>
                        <span>${fmtDate(n.timestamp)}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function updateDashboardData() {
        if (!tenantId() || !document.getElementById('db-kpi-inventory-value')) return;
        const dashboardData = {};

        // --- 1. Cálculos de KPIs ---
        dashboardData.inventoryDetails = appState.products.map(p => {
            const stock = appState.inventory[p.id] || {};
            const totalUnits = (stock.bodega?.unidades || 0) + (stock.barra?.unidades || 0);
            return { ...p, totalUnits, totalValue: totalUnits * (p.precioCompra || 0) };
        });

        dashboardData.totalInventoryValue = dashboardData.inventoryDetails.reduce((sum, p) => sum + p.totalValue, 0);
        dashboardData.lowStockProducts = dashboardData.inventoryDetails.filter(p => p.totalUnits <= LOW_STOCK_THRESHOLD);
        
        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
        const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);

        let salesToday = [];
        for (const shift of appState.activeShifts) {
            salesToday.push(...shift.sales.filter(s => s.fecha && s.fecha.toDate() >= todayStart));
        }
        const closedShiftsSnapshot = await getDocs(query(colref.shifts, where("fin", ">=", todayStart)));
        for (const shiftDoc of closedShiftsSnapshot.docs) {
             const salesSnapshot = await getDocs(query(TCOL('shifts', shiftDoc.id, 'sales'), where("fecha", ">=", todayStart)));
             salesSnapshot.forEach(saleDoc => salesToday.push({id: saleDoc.id, ...saleDoc.data()}));
        }
        dashboardData.salesToday = salesToday;

        dashboardData.grossSalesToday = salesToday.reduce((sum, sale) => sum + sale.totalVenta, 0);
        dashboardData.costOfGoodsSoldToday = salesToday.reduce((sum, sale) => {
            const product = appState.products.find(p => p.id === sale.productId);
            return sum + (sale.unidades * (product?.precioCompra || 0));
        }, 0);

        dashboardData.cashflowToday = appState.cashflow.filter(cf => cf.date && cf.date.toDate() >= todayStart);
        dashboardData.expensesToday = dashboardData.cashflowToday.filter(cf => cf.type === 'egreso').reduce((sum, entry) => sum + entry.amount, 0);
        dashboardData.totalCostsToday = dashboardData.costOfGoodsSoldToday + dashboardData.expensesToday;
        dashboardData.netProfitToday = dashboardData.grossSalesToday - dashboardData.totalCostsToday;
        dashboardData.averageTicketToday = salesToday.length > 0 ? dashboardData.grossSalesToday / salesToday.length : 0;

        dashboardData.providerBalance = appState.providers.reduce((sum, p) => sum + (p.saldoPendiente || 0), 0);
        dashboardData.providersWithBalance = appState.providers.filter(p => p.saldoPendiente > 0);

        dashboardData.activeLoans = appState.activeShifts.flatMap(s => s.loans.map(l => ({...l, worker: appState.workers.find(w => w.id === s.workerId)?.nombre || 'N/A' })));
        dashboardData.totalActiveLoans = dashboardData.activeLoans.reduce((sum, l) => sum + l.valor, 0);

        appState.dashboardData = dashboardData;

        // --- 2. Actualización del DOM para KPIs ---
        document.getElementById('db-kpi-inventory-value').textContent = COP(dashboardData.totalInventoryValue);
        document.getElementById('db-kpi-gross-sales').textContent = COP(dashboardData.grossSalesToday);
        document.getElementById('db-kpi-total-costs').textContent = COP(-dashboardData.totalCostsToday);
        document.getElementById('db-kpi-net-profit').textContent = COP(dashboardData.netProfitToday);
        document.getElementById('db-kpi-net-profit').className = dashboardData.netProfitToday >= 0 ? 'amount-positive' : 'amount-negative';
        document.getElementById('db-kpi-low-stock').textContent = dashboardData.lowStockProducts.length;
        document.getElementById('db-kpi-provider-balance').textContent = COP(-dashboardData.providerBalance);
        document.getElementById('db-kpi-active-loans').textContent = COP(dashboardData.totalActiveLoans);
        document.getElementById('db-kpi-average-ticket').textContent = COP(dashboardData.averageTicketToday);
        
        // --- 3. Actualización de Tabla de Inventario ---
        const inventoryTableBody = document.getElementById('inventory-status-table');
        if (inventoryTableBody) {
            inventoryTableBody.innerHTML = dashboardData.inventoryDetails.map(p => {
                const stock = appState.inventory[p.id] || {};
                const bodega = stock.bodega?.unidades || 0;
                const barra = stock.barra?.unidades || 0;
                let status, statusClass;
                if (p.totalUnits <= 0) { status = "Agotado"; statusClass = "out"; } 
                else if (p.totalUnits <= LOW_STOCK_THRESHOLD) { status = "Bajo"; statusClass = "low"; } 
                else { status = "Óptimo"; statusClass = "ok"; }
                const statusTag = `<span class="status-tag ${statusClass}">${status}</span>`;
                return row([p.nombre, bodega, barra, p.totalUnits, COP(p.totalValue), statusTag]);
            }).join('') || `<tr><td colspan="6">No hay productos para mostrar.</td></tr>`;
        }
        
        // --- 4. Renderizado de Gráficos ---
        let salesLast24h = [];
        for (const shift of appState.activeShifts) {
            salesLast24h.push(...shift.sales.filter(s => s.fecha && s.fecha.toDate() >= twentyFourHoursAgo));
        }
         const closedShifts24hSnapshot = await getDocs(query(colref.shifts, where("fin", ">=", twentyFourHoursAgo)));
        for (const shiftDoc of closedShifts24hSnapshot.docs) {
             const salesSnapshot = await getDocs(query(TCOL('shifts', shiftDoc.id, 'sales'), where("fecha", ">=", twentyFourHoursAgo)));
             salesSnapshot.forEach(saleDoc => salesLast24h.push(saleDoc.data()));
        }

        renderBarChart(salesLast24h);
        renderDonutChart(dashboardData.salesToday);
    }
    
    // --- Funciones para Gráficos D3 ---
    function renderBarChart(salesData) {
        const container = d3.select("#bar-chart-container");
        container.selectAll("*").remove(); 

        if (salesData.length === 0) {
            container.append("p").style("text-align", "center").style("color", "var(--text-secondary)").text("Sin ventas en las últimas 24h.");
            return;
        }

        const hourlyData = d3.rollups(salesData, v => d3.sum(v, d => d.totalVenta), d => d.fecha.toDate().getHours())
            .map(([key, value]) => ({ hour: key, total: value }))
            .sort((a,b) => a.hour - b.hour);

        const margin = {top: 20, right: 20, bottom: 30, left: 50};
        const width = container.node().getBoundingClientRect().width - margin.left - margin.right;
        const height = 250 - margin.top - margin.bottom;

        const svg = container.append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
            
        svg.append("defs").html(`<linearGradient id="barGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="var(--grad-red)" />
            <stop offset="50%" stop-color="var(--grad-orange)" />
            <stop offset="100%" stop-color="var(--grad-yellow)" />
        </linearGradient>`);

        const x = d3.scaleBand()
            .domain(d3.range(24))
            .range([0, width])
            .padding(0.2);

        const y = d3.scaleLinear()
            .domain([0, d3.max(hourlyData, d => d.total) * 1.1 || 1])
            .range([height, 0]);
            
        svg.append("g")
            .attr("class", "axis")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i) => !(i%3))));
            
        svg.append("g")
            .attr("class", "axis")
            .call(d3.axisLeft(y).ticks(5).tickFormat(d => `${d/1000}k`));
            
        const tooltip = d3.select("body").append("div").attr("class", "d3-tooltip");

        svg.selectAll(".bar")
            .data(hourlyData)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.hour))
            .attr("y", d => y(d.total))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.total))
            .attr("fill", "url(#barGradient)")
            .on("mouseover", (event, d) => {
                tooltip.transition().style("opacity", .9);
                tooltip.html(`<strong>${d.hour}:00h</strong><br/>${COP(d.total)}`)
                    .style("left", (event.pageX + 5) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", () => {
                tooltip.transition().style("opacity", 0);
            });
    }

    function renderDonutChart(salesData) {
        const container = d3.select("#donut-chart-container");
        container.selectAll("*").remove();

        if (salesData.length === 0) {
            container.append("p").style("text-align", "center").style("color", "var(--text-secondary)").text("Sin ventas hoy.");
            return;
        }

        const productData = d3.rollups(salesData, v => d3.sum(v, d => d.totalVenta), d => d.productId)
            .map(([key, value]) => ({
                productId: key,
                name: appState.products.find(p => p.id === key)?.nombre || 'Desconocido',
                total: value
            }))
            .sort((a,b) => b.total - a.total)
            .slice(0, 5);

        const width = container.node().getBoundingClientRect().width;
        const height = 250;
        const radius = Math.min(width, height) / 2 - 20;
        
        const svg = container.append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

        const color = d3.scaleOrdinal()
            .domain(productData.map(d => d.productId))
            .range(d3.quantize(t => d3.interpolateSpectral(t * 0.7 + 0.1), productData.length).reverse());
            
        const pie = d3.pie().value(d => d.total);
        const data_ready = pie(productData);

        const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.8);
        
        const tooltip = d3.select("body").append("div").attr("class", "d3-tooltip");
        
        svg.selectAll('path')
            .data(data_ready)
            .enter()
            .append('path')
            .attr('d', arc)
            .attr('fill', d => color(d.data.productId))
            .attr("stroke", "var(--bg-secondary)")
            .style("stroke-width", "3px")
            .on("mouseover", (event, d) => {
                tooltip.transition().style("opacity", .9);
                tooltip.html(`<strong>${d.data.name}</strong><br/>${COP(d.data.total)}`)
                    .style("left", (event.pageX + 5) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", () => {
                tooltip.transition().style("opacity", 0);
            });
    }


    function attachHandlers(id){
        if (id === 'dashboard-view') {
            updateDashboardData();
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(updateDashboardData, 250);
            });
            content.querySelector('.kpi-grid')?.addEventListener('click', (e) => {
                const card = e.target.closest('.kpi-card');
                if (card) {
                    showKpiBreakdown(card.dataset.kpi);
                }
            });
        }
        if (id === 'reports-view') {
            document.getElementById('reports-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true;
                btn.textContent = 'Generando...';

                try {
                    await generateReport();
                } catch(err) {
                    showToast(`Error al generar reporte: ${err.message}`, 'error');
                    console.error(err);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Generar Reporte';
                }
            });
            document.getElementById('report-output')?.addEventListener('click', e => {
                if (e.target.id === 'export-pdf-btn') exportReportPDF();
                if (e.target.id === 'export-excel-btn') exportReportExcel();
            });
        }
        if (id === 'products-view') {
            content.querySelectorAll(".btn-edit").forEach(b => b.addEventListener("click", () => {
                const p = appState.products.find(x => x.id === b.dataset.id); if (!p) return;
                document.getElementById("product-id").value = p.id;
                document.getElementById("product-nombre").value = p.nombre || "";
                document.getElementById("product-precioVenta").value = p.precioVenta || 0;
                document.getElementById("product-precioCompra").value = p.precioCompra || 0;
                document.getElementById("product-precioComision").value = p.precioComision || 0;
                document.getElementById("product-unidadesPorCaja").value = p.unidadesPorCaja || 1;
                document.getElementById("product-unidadesPorCanasta").value = p.unidadesPorCanasta || 1;
                document.getElementById("product-esFicha").checked = !!p.esFicha;
                document.getElementById("product-providerPorVentas").value = p.providerPorVentasId || "";
            }));
            const form = document.getElementById("product-form");
            if (form) form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]'); btn.disabled = true;
                const id = document.getElementById("product-id").value;
                const data = {
                    nombre: document.getElementById("product-nombre").value,
                    precioVenta: parseFloat(document.getElementById("product-precioVenta").value),
                    precioCompra: parseFloat(document.getElementById("product-precioCompra").value),
                    precioComision: parseFloat(document.getElementById("product-precioComision").value) || 0,
                    unidadesPorCaja: parseInt(document.getElementById("product-unidadesPorCaja").value) || 1,
                    unidadesPorCanasta: parseInt(document.getElementById("product-unidadesPorCanasta").value) || 1,
                    esFicha: document.getElementById("product-esFicha").checked,
                    providerPorVentasId: document.getElementById("product-providerPorVentas").value || null,
                    activo: true
                };
                try {
                    if (id) {
                        await setDoc(doc(colref.products, id), data, { merge: true });
                    } else {
                        const ref = await addDoc(colref.products, data);
                        const b = writeBatch(db);
                        b.set(stockRef(ref.id, "bodega"), { tenantId: tenantId(), unidades: 0 }, { merge: true });
                        b.set(stockRef(ref.id, "barra"), { tenantId: tenantId(), unidades: 0 }, { merge: true });
                        await b.commit();
                    }
                    showToast("Guardado correctamente");
                    form.reset(); document.getElementById("product-id").value = "";
                } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
            });
        }
        if(id === 'inventory-view') {
            const purchaseProviderSelect = document.getElementById("purchase-provider");
            if (purchaseProviderSelect) {
                purchaseProviderSelect.addEventListener('change', (e) => {
                    const providerId = e.target.value;
                    const displayDiv = document.getElementById('provider-payment-type-display');
                    const strongEl = displayDiv.querySelector('strong');

                    if (!providerId) {
                        displayDiv.style.display = 'none';
                        return;
                    }

                    const provider = appState.providers.find(p => p.id === providerId);
                    if (provider) {
                        let tipoPagoText = 'Contado';
                        if (provider.tipoPago === 'consignacion') tipoPagoText = 'Consignación';
                        if (provider.tipoPago === 'porVentas') tipoPagoText = 'Por Ventas';
                        
                        strongEl.textContent = tipoPagoText;
                        displayDiv.style.display = 'block';
                    } else {
                        displayDiv.style.display = 'none';
                    }
                });
            }

            const purchaseForm = document.getElementById("purchase-form");
            if (purchaseForm) purchaseForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = purchaseForm.querySelector('button[type="submit"]');
                btn.disabled = true;
                
                const providerId = document.getElementById("purchase-provider").value;
                const productId = document.getElementById("purchase-product").value;
                const cantidad = parseInt(document.getElementById("purchase-quantity").value);
                const unit = document.getElementById("purchase-unit").value;
                const prod = appState.products.find(p => p.id === productId);
                const provider = appState.providers.find(p => p.id === providerId);

                if (!prod || !provider || isNaN(cantidad) || cantidad <= 0) {
                    showToast("Datos de compra inválidos", "error");
                    btn.disabled = false;
                    return;
                }

                try {
                    const unidades = toUnidades(cantidad, unit, prod);
                    const costo = unidades * (prod.precioCompra || 0);

                    await runTransaction(db, async (t) => {
                        const bodegaRef = stockRef(productId, "bodega");
                        const purchaseRef = doc(colref.purchases);
                        
                        t.update(bodegaRef, { unidades: increment(unidades) });

                        t.set(purchaseRef, {
                            providerId, productId, fecha: serverTimestamp(),
                            cantidadUnidades: unidades, costoTotal: costo
                        });
                        
                        if (provider.tipoPago === "consignacion") {
                            const providerRef = doc(colref.providers, providerId);
                            t.update(providerRef, { saldoPendiente: increment(costo) });
                        } else if (provider.tipoPago === "contado") {
                            const cashflowRef = doc(colref.cashflow); 
                            t.set(cashflowRef, {
                                type: "egreso", amount: costo,
                                description: `Compra contado: ${unidades} x ${prod.nombre}`,
                                date: serverTimestamp()
                            });
                        }
                    });

                    await createNotification(`Compra de ${unidades} x ${prod.nombre} a ${provider.nombre}.`, 'purchase');
                    showToast("Compra registrada exitosamente");
                    purchaseForm.reset();
                } catch (err) {
                    showToast(`Error en la compra: ${err.message}`, "error");
                } finally {
                    btn.disabled = false;
                }
            });
            const transferForm = document.getElementById("transfer-form");
            if (transferForm) transferForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = transferForm.querySelector('button[type="submit"]');
                btn.disabled = true;
                const productId = document.getElementById("transfer-product").value;
                const cantidad = parseInt(document.getElementById("transfer-quantity").value);
                const unit = document.getElementById("transfer-unit").value;
                const prod = appState.products.find(p => p.id === productId);
                if (!prod || isNaN(cantidad) || cantidad <= 0) {
                    showToast("Datos de traslado inválidos", "error");
                    btn.disabled = false; return;
                }
                const unidades = toUnidades(cantidad, unit, prod);
                try {
                    await runTransaction(db, async (t) => {
                        const bodegaRef = stockRef(productId, "bodega");
                        const barraRef = stockRef(productId, "barra");
                        const bodegaSnap = await t.get(bodegaRef);
                        const currentBodegaStock = bodegaSnap.data()?.unidades || 0;
                        if (currentBodegaStock < unidades) throw new Error("Stock insuficiente en bodega.");
                        
                        t.update(bodegaRef, { unidades: increment(-unidades) });
                        t.update(barraRef, { unidades: increment(unidades) });
                    });
                    
                    await checkAndNotifyLowStock(productId);
                    showToast("Traslado exitoso");
                    transferForm.reset();
                } catch (err) {
                    showToast(`Error en traslado: ${err.message}`, "error");
                } finally {
                    btn.disabled = false;
                }
            });
        }
        if(id === 'cashflow-view') {
            const form = document.getElementById("cashflow-form");
            if (form) form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]');
                btn.disabled = true;
                const data = {
                    type: document.getElementById("cashflow-type").value,
                    amount: parseFloat(document.getElementById("cashflow-amount").value),
                    description: document.getElementById("cashflow-description").value,
                    date: serverTimestamp(),
                    manual: true,
                    userId: appState.user.uid
                };
                try {
                    await addDoc(colref.cashflow, data);
                    showToast("Movimiento registrado");
                    form.reset();
                } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
            });
        }
        if (id === 'providers-view') {
            content.querySelectorAll(".btn-edit-provider").forEach(b => b.addEventListener("click", () => {
                const p = appState.providers.find(x => x.id === b.dataset.id); if (!p) return;
                document.getElementById("provider-id").value = p.id;
                document.getElementById("provider-nombre").value = p.nombre || "";
                document.getElementById("provider-contacto").value = p.contacto || "";
                document.getElementById("provider-tipoPago").value = p.tipoPago || 'contado';
            }));
            const form = document.getElementById("provider-form");
            if (form) form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]'); btn.disabled = true;
                const id = document.getElementById("provider-id").value;
                const data = {
                    nombre: document.getElementById("provider-nombre").value,
                    contacto: document.getElementById("provider-contacto").value,
                    tipoPago: document.getElementById("provider-tipoPago").value
                };
                try {
                    if (id) {
                        await setDoc(doc(colref.providers, id), data, { merge: true });
                    } else {
                        await addDoc(colref.providers, { ...data, saldoPendiente: 0 });
                    }
                    showToast("Proveedor guardado");
                    form.reset(); document.getElementById("provider-id").value = "";
                } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
            });
            content.querySelectorAll(".btn-settle").forEach(b => b.addEventListener("click", () => {
                const prov = appState.providers.find(x => x.id === b.dataset.id); if (!prov) return;
                if ((prov.saldoPendiente || 0) <= 0) { showToast("Proveedor sin saldo pendiente.", "error"); return; }
                document.getElementById("settlement-provider-name").textContent = prov.nombre;
                document.getElementById("settlement-provider-balance").textContent = COP(prov.saldoPendiente || 0);
                document.getElementById("settle-provider-btn").dataset.providerId = prov.id;
                document.getElementById("settlement-details").classList.remove("hidden");
            }));
            const settleBtn = document.getElementById("settle-provider-btn");
            if (settleBtn) settleBtn.addEventListener("click", async (e) => {
                const providerId = e.target.dataset.providerId;
                const prov = appState.providers.find(p => p.id === providerId); if (!prov) return;
                const batch = writeBatch(db);
                batch.set(doc(colref.cashflow), {
                    type: "egreso", amount: prov.saldoPendiente,
                    description: `Pago liquidación: ${prov.nombre}`, date: serverTimestamp()
                });
                batch.set(doc(colref.providers, providerId), { saldoPendiente: 0 }, { merge: true });
                try {
                    await batch.commit();
                    showToast("Liquidación realizada");
                    document.getElementById("settlement-details").classList.add("hidden");
                } catch (err) { showToast(err.message, "error"); }
            });
            
            content.querySelectorAll(".btn-view-sales-breakdown").forEach(b => b.addEventListener("click", async (e) => {
                const providerId = e.target.dataset.id;
                const provider = appState.providers.find(p => p.id === providerId);
                if (!provider) return;

                const modal = document.getElementById("sales-breakdown-modal");
                const modalTitle = document.getElementById("sales-breakdown-modal-title");
                const modalBody = document.getElementById("sales-breakdown-modal-body");

                modalTitle.textContent = `Desglose de ${provider.nombre}`;
                modalBody.innerHTML = `<p>Calculando reporte...</p>`;
                modal.classList.add("visible");

                try {
                    const associatedProducts = appState.products.filter(p => p.providerPorVentasId === providerId);
                    if (associatedProducts.length === 0) {
                        modalBody.innerHTML = `<p>Este proveedor no está asociado a ningún producto para pago por ventas.</p>`;
                        return;
                    }
                    const associatedProductIds = associatedProducts.map(p => p.id);

                    const purchasesQuery = query(colref.purchases, where("providerId", "==", providerId), where("productId", "in", associatedProductIds));
                    const purchasesSnapshot = await getDocs(purchasesQuery);
                    const purchasesByProduct = {};
                    purchasesSnapshot.docs.forEach(d => {
                        const data = d.data();
                        purchasesByProduct[data.productId] = (purchasesByProduct[data.productId] || 0) + data.cantidadUnidades;
                    });
                    
                    const shiftsSnapshot = await getDocs(colref.shifts);
                    const salesByProduct = {};
                    for (const shiftDoc of shiftsSnapshot.docs) {
                        const salesQuery = query(TCOL('shifts', shiftDoc.id, 'sales'), where("productId", "in", associatedProductIds));
                        const salesSnapshot = await getDocs(salesQuery);
                        salesSnapshot.docs.forEach(d => {
                            const data = d.data();
                            salesByProduct[data.productId] = (salesByProduct[data.productId] || 0) + data.unidades;
                        });
                    }

                    let totalDebtGenerated = 0;
                    const tableRows = associatedProducts.map(p => {
                        const purchased = purchasesByProduct[p.id] || 0;
                        const sold = salesByProduct[p.id] || 0;
                        const stock = purchased - sold;
                        const debt = sold * (p.precioCompra || 0);
                        totalDebtGenerated += debt;
                        return row([p.nombre, purchased, sold, stock, COP(p.precioCompra || 0), COP(debt)]);
                    }).join('');
                    
                    const previousLiquidations = totalDebtGenerated - (provider.saldoPendiente || 0);

                    modalBody.innerHTML = `
                        <div class="table-wrapper">
                            <table>
                                <thead><tr><th>Producto</th><th>Comprado</th><th>Vendido</th><th>Stock Prov.</th><th>Costo Unit.</th><th>Deuda Generada</th></tr></thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>
                        <div style="margin-top: 20px; text-align: right; font-size: 1.1em;">
                            <p><strong>Deuda Total Generada por Ventas:</strong> ${COP(totalDebtGenerated)}</p>
                            <p style="color: var(--text-secondary);">Liquidaciones Anteriores: ${COP(previousLiquidations)}</p>
                            <h4 style="margin-top: 10px; font-size: 1.2em;">Saldo Pendiente Actual: <span style="color: var(--brand-primary);">${COP(provider.saldoPendiente || 0)}</span></h4>
                        </div>
                    `;

                } catch (error) {
                    console.error("Error generating breakdown:", error);
                    modalBody.innerHTML = `<p class="toast error">Error al generar el reporte: ${error.message}</p>`;
                }
            }));
        }
        if (id === 'workers-view') {
            content.querySelectorAll(".btn-edit-worker").forEach(b => b.addEventListener("click", () => {
                const worker = appState.workers.find(x => x.id === b.dataset.id);
                if (!worker) return;
                const form = document.getElementById("worker-form");
                form.querySelector("#worker-id").value = worker.id;
                form.querySelector("#worker-nombre").value = worker.nombre || "";
                form.querySelector("#worker-pagoBase").value = worker.pagoBase || 0;
                form.querySelector("#worker-activo").checked = worker.activo === true;
            }));
            const form = document.getElementById("worker-form");
            if (form) form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]');
                btn.disabled = true;
                const workerId = document.getElementById("worker-id").value;
                const data = {
                    nombre: document.getElementById("worker-nombre").value.trim(),
                    pagoBase: parseFloat(document.getElementById("worker-pagoBase").value) || 0,
                    activo: document.getElementById("worker-activo").checked,
                };
                if (!data.nombre) {
                    showToast("El nombre del trabajador es requerido.", "error");
                    btn.disabled = false; return;
                }
                try {
                    if (workerId) {
                        await setDoc(doc(colref.workers, workerId), data, { merge: true });
                    } else {
                        await addDoc(colref.workers, { ...data, createdAt: serverTimestamp() });
                    }
                    showToast("Trabajador guardado correctamente.");
                    form.reset();
                    document.getElementById("worker-id").value = "";
                    document.getElementById("worker-activo").checked = true;
                } catch (err) { 
                    console.error("Error guardando trabajador:", err);
                    showToast(`Error: ${err.message}`, "error"); 
                } finally { btn.disabled = false; }
            });
        }
        if (id === 'profile-view') {
            const personalForm = document.getElementById("profile-personal-form");
            if (personalForm) personalForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
                try {
                    const tenantRef = doc(db, "tenants", appState.user.uid);
                    const newDisplayName = document.getElementById("profile-name").value;
                    const newPhone = document.getElementById("profile-phone").value;
                    await setDoc(tenantRef, { ownerName: newDisplayName, phone: newPhone }, { merge: true });
                    appState.userData.ownerName = newDisplayName;
                    appState.userData.phone = newPhone;
                    showToast("Datos personales actualizados");
                } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
            });
            const businessForm = document.getElementById("profile-business-form");
            if (businessForm) businessForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
                try {
                    const tenantRef = doc(db, "tenants", appState.user.uid);
                    const newBusinessName = document.getElementById("profile-business-name").value;
                    const newBusinessType = document.getElementById("profile-business-type").value;
                    await setDoc(tenantRef, { businessName: newBusinessName, businessType: newBusinessType }, { merge: true });
                    appState.userData.businessName = newBusinessName;
                    appState.userData.businessType = newBusinessType;
                    showToast("Datos del negocio actualizados");
                } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
            });
        }
        if(id === 'shifts-view') {
            if (appState.selectedShiftId) {
                document.getElementById("back-to-shifts-list")?.addEventListener("click", () => {
                    appState.selectedShiftId = null;
                    scheduleRender();
                });
                document.getElementById("fichas-grid")?.addEventListener("click", (e) => {
                    const card = e.target.closest(".ficha-card");
                    if (!card) return;
                    const productId = card.dataset.productId;
                    const product = appState.products.find(p => p.id === productId);
                    const stock = appState.inventory[productId]?.barra?.unidades ?? 0;
                    const modal = document.getElementById("ficha-sale-modal");
                    modal.querySelector("#ficha-sale-modal-title").textContent = `Vender ${product.nombre}`;
                    modal.querySelector("#ficha-sale-product-id").value = productId;
                    modal.querySelector("#ficha-sale-stock").textContent = stock;
                    modal.querySelector("#ficha-sale-quantity").value = 1;
                    modal.classList.add("visible");
                });
                document.getElementById("open-loan-modal-btn")?.addEventListener("click", () => {
                    document.getElementById("loan-modal").classList.add("visible");
                });
                document.getElementById("close-shift-btn")?.addEventListener("click", async (e) => {
                    const btn = e.target;
                    const isConfirmed = btn.dataset.confirmed === 'true';
                    if (!isConfirmed) {
                        btn.dataset.originalText = btn.textContent;
                        btn.textContent = '¿Confirmar Cierre?';
                        btn.style.background = 'var(--brand-secondary)';
                        btn.dataset.confirmed = 'true';
                        const timeoutId = setTimeout(() => {
                            btn.textContent = btn.dataset.originalText;
                            btn.style.background = '';
                            btn.dataset.confirmed = 'false';
                        }, 4000);
                        btn.dataset.timeoutId = timeoutId;
                        return;
                    }
                    clearTimeout(btn.dataset.timeoutId);
                    btn.disabled = true;
                    const shiftId = btn.dataset.shiftId;
                    const shift = appState.activeShifts.find(s => s.id === shiftId);
                    if (!shift) { btn.disabled = false; return; }
                    const worker = appState.workers.find(w => w.id === shift.workerId);
                    const ingresos = shift.sales.reduce((s, x) => s + x.totalVenta, 0);
                    const comisiones = shift.sales.reduce((s, x) => s + (x.totalComision || 0), 0);
                    const prestamos = shift.loans.reduce((s, l) => s + l.valor, 0);
                    const totalAPagar = (worker?.pagoBase || 0) + comisiones - prestamos;
                    try {
                        const batch = writeBatch(db);
                        batch.set(doc(colref.cashflow), { type: "ingreso", amount: ingresos, description: `Cierre turno ${worker?.nombre || ""}`, date: serverTimestamp() });
                        if (totalAPagar > 0) {
                            batch.set(doc(colref.cashflow), { type: "egreso", amount: totalAPagar, description: `Pago liquidación ${worker?.nombre || ""}`, date: serverTimestamp() });
                        }
                        batch.set(doc(colref.shifts, shift.id), { estado: "cerrado", fin: serverTimestamp(), totalIngresos: ingresos, totalComisiones: comisiones, totalPrestamos: prestamos, totalPagado: totalAPagar }, { merge: true });
                        await batch.commit();
                        appState.selectedShiftId = null;
                        showToast("Turno cerrado y liquidado");
                    } catch (err) {
                        showToast(err.message, "error");
                        btn.textContent = btn.dataset.originalText;
                        btn.style.background = '';
                        btn.dataset.confirmed = 'false';
                        btn.disabled = false;
                    }
                });
            } else {
                document.getElementById("open-shift-form")?.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const workerId = document.getElementById("shift-worker").value;
                    if (!workerId) return;
                    
                    const btn = e.target.querySelector('button[type="submit"]');
                    btn.disabled = true;

                    try {
                        const worker = appState.workers.find(w => w.id === workerId);
                        await addDoc(colref.shifts, {
                            workerId,
                            pagoBase: worker?.pagoBase || 0,
                            inicio: serverTimestamp(),
                            estado: "abierto"
                        });
                        await createNotification(`${worker.nombre} ha iniciado turno.`, 'shift');
                    } catch(err) {
                        showToast(err.message, 'error');
                    } finally {
                        btn.disabled = false;
                    }
                });
                content.querySelectorAll('.btn-manage-shift').forEach(btn => btn.addEventListener('click', (e) => {
                    appState.selectedShiftId = e.target.dataset.shiftId;
                    scheduleRender();
                }));
                content.querySelectorAll('.btn-view-desglose').forEach(btn => btn.addEventListener('click', (e) => {
                    const shiftId = e.target.dataset.shiftId;
                    const shift = appState.activeShifts.find(s => s.id === shiftId); if (!shift) return;
                    const worker = appState.workers.find(w => w.id === shift.workerId);
                    document.getElementById('desglose-modal-title').textContent = `Desglose de ${worker?.nombre || '...'}`;
                    const combinedEvents = [
                        ...shift.sales.map(s => ({ ...s, eventType: 'sale' })),
                        ...shift.loans.map(l => ({ ...l, eventType: 'loan' }))
                    ];
                    if (combinedEvents.length > 0 && combinedEvents[0].fecha?.toMillis) {
                        combinedEvents.sort((a, b) => a.fecha.toMillis() - b.fecha.toMillis());
                    }
                    const tableBody = combinedEvents.map(event => {
                        const time = event.fecha?.toDate().toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' }) || 'N/A';
                        if (event.eventType === 'sale') {
                            const product = appState.products.find(p => p.id === event.productId);
                            const description = `${event.unidades} x ${product?.nombre || 'Ficha vendida'}`;
                            return row([time, description, COP(event.totalVenta), COP(event.totalComision), '']);
                        } else {
                            return row([time, `Préstamo: ${event.descripcion}`, '', '', COP(event.valor)]);
                        }
                    }).join('');
                    document.getElementById('desglose-modal-body').innerHTML = `<table><thead><tr><th>Hora</th><th>Descripción</th><th>Ingreso</th><th>Comisión</th><th>Préstamo</th></tr></thead><tbody>${tableBody || `<tr><td colspan="5">No hay eventos registrados.</td></tr>`}</tbody></table>`;
                    document.getElementById('desglose-modal').classList.add('visible');
                }));
            }
        }
    }
    
    // --- Manejo de Modales ---
    document.querySelectorAll(".modal").forEach(modal => {
        const closeBtn = modal.querySelector(".modal-close-btn");
        if (closeBtn) {
            closeBtn.addEventListener("click", () => modal.classList.remove("visible"));
        }
        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.classList.remove("visible");
            }
        });
    });

    function showKpiBreakdown(kpiType) {
        const modal = document.getElementById('kpi-breakdown-modal');
        const titleEl = document.getElementById('kpi-breakdown-modal-title');
        const bodyEl = document.getElementById('kpi-breakdown-modal-body');
        const data = appState.dashboardData;
        let title = "Desglose";
        let contentHtml = "<p>No hay datos para mostrar.</p>";

        switch (kpiType) {
            case 'inventory-value':
                title = "Desglose de Valor de Inventario";
                const invRows = data.inventoryDetails.map(p => row([p.nombre, p.totalUnits, COP(p.precioCompra || 0), COP(p.totalValue)])).join('');
                contentHtml = `<div class="table-wrapper"><table><thead><tr><th>Producto</th><th>Unidades Totales</th><th>Costo Unit.</th><th>Valor Subtotal</th></tr></thead><tbody>${invRows}</tbody></table></div>`;
                break;
            case 'net-profit':
                title = "Desglose de Ganancia Neta (Hoy)";
                contentHtml = `<div class="breakdown-summary">
                    <p><span>(+) Ventas Brutas:</span> <span>${COP(data.grossSalesToday)}</span></p>
                    <p><span>(-) Costo de Mercancía:</span> <span>${COP(-data.costOfGoodsSoldToday)}</span></p>
                    <p><span>(-) Otros Egresos:</span> <span>${COP(-data.expensesToday)}</span></p>
                    <hr>
                    <h4><span>(=) Ganancia Neta:</span> <span class="${data.netProfitToday >= 0 ? 'amount-positive' : 'amount-negative'}">${COP(data.netProfitToday)}</span></h4>
                </div>`;
                break;
            case 'gross-sales':
                title = "Desglose de Ventas Brutas (Hoy)";
                const salesRows = data.salesToday.map(s => {
                    const p = appState.products.find(p => p.id === s.productId);
                    return row([fmtTime(s.fecha), p?.nombre || 'N/A', s.unidades, COP(s.totalVenta)]);
                }).join('');
                contentHtml = `<div class="table-wrapper"><table><thead><tr><th>Hora</th><th>Producto</th><th>Cant.</th><th>Total Venta</th></tr></thead><tbody>${salesRows || `<tr><td colspan="4">Sin ventas hoy.</td></tr>`}</tbody></table></div>`;
                break;
            case 'total-costs':
                 title = "Desglose de Costos Totales (Hoy)";
                 const costGoodsRows = data.salesToday.map(s => {
                    const p = appState.products.find(p => p.id === s.productId);
                    return row([p?.nombre || 'N/A', s.unidades, COP(s.unidades * (p?.precioCompra || 0))]);
                 }).join('');
                 const expensesRows = data.cashflowToday.filter(cf => cf.type === 'egreso').map(e => row([fmtTime(e.date), e.description, COP(e.amount)])).join('');
                 contentHtml = `<h4>Costo de Mercancía Vendida (${COP(data.costOfGoodsSoldToday)})</h4>
                 <div class="table-wrapper" style="margin-bottom: 20px;"><table><thead><tr><th>Producto</th><th>Cant. Vendida</th><th>Costo Total</th></tr></thead><tbody>${costGoodsRows || `<tr><td colspan="3">Sin ventas.</td></tr>`}</tbody></table></div>
                 <h4>Otros Egresos (${COP(data.expensesToday)})</h4>
                 <div class="table-wrapper"><table><thead><tr><th>Hora</th><th>Descripción</th><th>Monto</th></tr></thead><tbody>${expensesRows || `<tr><td colspan="3">Sin egresos.</td></tr>`}</tbody></table></div>`;
                break;
            case 'low-stock':
                title = "Productos con Bajo Stock";
                const lowStockRows = data.lowStockProducts.map(p => row([p.nombre, p.totalUnits, `<span class="status-tag ${p.totalUnits <= 0 ? 'out' : 'low'}">${p.totalUnits <= 0 ? 'Agotado' : 'Bajo'}</span>`])).join('');
                contentHtml = `<div class="table-wrapper"><table><thead><tr><th>Producto</th><th>Stock Total</th><th>Estado</th></tr></thead><tbody>${lowStockRows || `<tr><td colspan="3">Ningún producto con bajo stock.</td></tr>`}</tbody></table></div>`;
                break;
            case 'provider-balance':
                title = "Saldo Pendiente a Proveedores";
                const providerRows = data.providersWithBalance.map(p => row([p.nombre, COP(p.saldoPendiente)])).join('');
                contentHtml = `<div class="table-wrapper"><table><thead><tr><th>Proveedor</th><th>Saldo Pendiente</th></tr></thead><tbody>${providerRows || `<tr><td colspan="2">Sin saldos pendientes.</td></tr>`}</tbody></table></div>`;
                break;
            case 'active-loans':
                title = "Préstamos en Turnos Activos";
                const loanRows = data.activeLoans.map(l => row([l.worker, l.descripcion, COP(l.valor), fmtTime(l.fecha)])).join('');
                contentHtml = `<div class="table-wrapper"><table><thead><tr><th>Trabajador</th><th>Descripción</th><th>Valor</th><th>Hora</th></tr></thead><tbody>${loanRows || `<tr><td colspan="4">Sin préstamos activos.</td></tr>`}</tbody></table></div>`;
                break;
            case 'average-ticket':
                title = "Cálculo del Ticket Promedio (Hoy)";
                contentHtml = `<div class="breakdown-summary">
                    <p><span>Total Ventas Brutas:</span> <span>${COP(data.grossSalesToday)}</span></p>
                    <p><span>Número de Ventas:</span> <span>${data.salesToday.length}</span></p>
                    <hr>
                    <h4><span>(=) Ticket Promedio:</span> <span>${COP(data.averageTicketToday)}</span></h4>
                </div>`;
                break;
        }

        titleEl.textContent = title;
        bodyEl.innerHTML = contentHtml;
        modal.classList.add('visible');
    }

    async function generateReport() {
        const startDate = new Date(document.getElementById('report-start-date').value);
        const endDate = new Date(document.getElementById('report-end-date').value);

        if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
            showToast("Por favor, selecciona un rango de fechas válido.", "error");
            return;
        }
        
        const reportOutput = document.getElementById('report-output');
        reportOutput.innerHTML = `<p style="text-align: center;">Cargando datos del reporte...</p>`;

        const shiftsSnapshot = await getDocs(query(colref.shifts, where("inicio", ">=", startDate), where("inicio", "<=", endDate)));
        let allSales = [];
        for (const shiftDoc of shiftsSnapshot.docs) {
            const salesSnapshot = await getDocs(TCOL('shifts', shiftDoc.id, 'sales'));
            salesSnapshot.forEach(saleDoc => allSales.push({ id: saleDoc.id, ...saleDoc.data() }));
        }

        const filteredCashflow = appState.cashflow.filter(cf => cf.date && cf.date.toDate() >= startDate && cf.date.toDate() <= endDate);
        
        const grossSales = allSales.reduce((sum, sale) => sum + sale.totalVenta, 0);
        const unitsSold = allSales.reduce((sum, sale) => sum + sale.unidades, 0);
        const costOfGoods = allSales.reduce((sum, sale) => {
            const product = appState.products.find(p => p.id === sale.productId);
            return sum + (sale.unidades * (product?.precioCompra || 0));
        }, 0);
        const otherExpenses = filteredCashflow.filter(cf => cf.type === 'egreso').reduce((sum, entry) => sum + entry.amount, 0);
        const totalCosts = costOfGoods + otherExpenses;
        const netProfit = grossSales - totalCosts;

        appState.reportDataCache = {
            startDate, endDate, grossSales, unitsSold, costOfGoods, otherExpenses, totalCosts, netProfit,
            sales: allSales,
            expenses: filteredCashflow.filter(cf => cf.type === 'egreso')
        };
        
        const salesRows = allSales.map(s => {
            const p = appState.products.find(p => p.id === s.productId);
            return row([fmtDate(s.fecha), p?.nombre || 'N/A', s.unidades, COP(s.totalVenta)]);
        }).join('');
        
        const expensesRows = appState.reportDataCache.expenses.map(e => row([fmtDate(e.date), e.description, COP(e.amount)])).join('');

        reportOutput.innerHTML = `
            <div class="kpi-grid">
                <div class="card kpi-card"><h3>Ganancia Bruta</h3><p class="amount-positive">${COP(grossSales)}</p></div>
                <div class="card kpi-card"><h3>Costos Totales</h3><p class="amount-negative">${COP(-totalCosts)}</p></div>
                <div class="card kpi-card"><h3>Ganancia Neta</h3><p class="${netProfit >= 0 ? 'amount-positive' : 'amount-negative'}">${COP(netProfit)}</p></div>
                <div class="card kpi-card"><h3>Unidades Vendidas</h3><p>${unitsSold}</p></div>
            </div>
            <div style="display: flex; gap: 12px; margin-bottom: 24px; justify-content: flex-end;">
                 <button id="export-excel-btn" class="button-secondary">Exportar a Excel</button>
                 <button id="export-pdf-btn">Exportar a PDF</button>
            </div>
            <div class="card" style="margin-bottom: 24px;">
                <h2>Ventas Detalladas</h2>
                <div class="table-wrapper"><table id="sales-report-table"><thead><tr><th>Fecha</th><th>Producto</th><th>Cant.</th><th>Total</th></tr></thead><tbody>${salesRows || `<tr><td colspan="4">Sin ventas en este período.</td></tr>`}</tbody></table></div>
            </div>
            <div class="card">
                <h2>Egresos Detallados</h2>
                <div class="table-wrapper"><table id="expenses-report-table"><thead><tr><th>Fecha</th><th>Descripción</th><th>Monto</th></tr></thead><tbody>${expensesRows || `<tr><td colspan="3">Sin egresos en este período.</td></tr>`}</tbody></table></div>
            </div>`;
    }

    function exportReportPDF() {
        if (!appState.reportDataCache) {
            showToast("Primero genera un reporte.", "error");
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const { startDate, endDate, sales, expenses, ...summary } = appState.reportDataCache;

        doc.setFontSize(18);
        doc.text(`Reporte Financiero - ${appState.userData.businessName}`, 14, 22);
        doc.setFontSize(11);
        doc.text(`Periodo: ${startDate.toLocaleString('es-CO')} - ${endDate.toLocaleString('es-CO')}`, 14, 30);

        doc.autoTable({
            startY: 40,
            head: [['Métrica', 'Valor']],
            body: [
                ['Ganancia Bruta (Ventas)', COP(summary.grossSales)],
                ['Costo de Mercancía Vendida', COP(-summary.costOfGoods)],
                ['Otros Egresos (Flujo de Caja)', COP(-summary.otherExpenses)],
                [{ content: 'Ganancia Neta', styles: { fontStyle: 'bold' } }, { content: COP(summary.netProfit), styles: { fontStyle: 'bold' } }],
            ],
            theme: 'grid',
            headStyles: { fillColor: [255, 111, 0] }
        });

        if (sales.length > 0) {
            doc.autoTable({
                startY: doc.autoTable.previous.finalY + 10,
                head: [['Fecha', 'Producto', 'Cant.', 'Total Venta']],
                body: sales.map(s => {
                    const p = appState.products.find(p => p.id === s.productId);
                    return [fmtDate(s.fecha), p?.nombre || 'N/A', s.unidades, COP(s.totalVenta)];
                }),
                theme: 'striped',
                headStyles: { fillColor: [48, 49, 52] }
            });
        }
        
        if (expenses.length > 0) {
             doc.autoTable({
                startY: doc.autoTable.previous.finalY + 10,
                head: [['Fecha', 'Descripción Egreso', 'Monto']],
                body: expenses.map(e => [fmtDate(e.date), e.description, COP(e.amount)]),
                theme: 'striped',
                headStyles: { fillColor: [48, 49, 52] }
            });
        }

        doc.save(`Reporte_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    function exportReportExcel() {
        if (!appState.reportDataCache) {
            showToast("Primero genera un reporte.", "error");
            return;
        }
        const { sales, expenses, ...summary } = appState.reportDataCache;
        
        const summaryData = [
            { Métrica: 'Ganancia Bruta (Ventas)', Valor: summary.grossSales },
            { Métrica: 'Costo de Mercancía Vendida', Valor: summary.costOfGoods },
            { Métrica: 'Otros Egresos (Flujo de Caja)', Valor: summary.otherExpenses },
            { Métrica: 'Costos Totales', Valor: summary.totalCosts },
            { Métrica: 'Ganancia Neta', Valor: summary.netProfit },
            { Métrica: 'Unidades Vendidas', Valor: summary.unitsSold },
        ];
        const salesData = sales.map(s => {
             const p = appState.products.find(p => p.id === s.productId);
             return {
                Fecha: s.fecha.toDate(),
                Producto: p?.nombre || 'N/A',
                Cantidad: s.unidades,
                'Valor Comisión': s.totalComision,
                'Valor Venta': s.totalVenta
             };
        });
        const expensesData = expenses.map(e => ({
            Fecha: e.date.toDate(),
            Descripción: e.description,
            Monto: e.amount
        }));

        const wb = XLSX.utils.book_new();
        const wsSummary = XLSX.utils.json_to_sheet(summaryData);
        const wsSales = XLSX.utils.json_to_sheet(salesData);
        const wsExpenses = XLSX.utils.json_to_sheet(expensesData);

        XLSX.utils.book_append_sheet(wb, wsSummary, "Resumen");
        XLSX.utils.book_append_sheet(wb, wsSales, "Ventas Detalladas");
        XLSX.utils.book_append_sheet(wb, wsExpenses, "Egresos Detallados");

        XLSX.writeFile(wb, `Reporte_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

  </script>


<!-- jsPDF + AutoTable CDNs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.autotable.min.js"></script>
<script>
(function(){
  'use strict';
  function getBusinessName(){
    try{
      const name = (window.appState && window.appState.userData && window.appState.userData.businessName)
        || "Mi Negocio";
      if(typeof name === 'string' && name.trim().length>0) return name.trim();
      return "Mi Negocio";
    }catch(e){ return "Mi Negocio"; }
  }

  function formatDateForFilename(d){
    const pad = (n)=> String(n).padStart(2,'0');
    return d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate()) + "_" + pad(d.getHours()) + "-" + pad(d.getMinutes());
  }

  function generatePDF(){
    try{
      if (!window.appState || !window.appState.reportDataCache) {
        alert("Primero genera un reporte.");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const { startDate, endDate, sales, expenses, ...summary } = window.appState.reportDataCache;
      const businessName = getBusinessName();

      doc.setFontSize(18);
      doc.text(`Reporte Financiero - ${businessName}`, 14, 22);
      doc.setFontSize(11);
      doc.text(`Periodo: ${startDate.toLocaleString('es-CO')} - ${endDate.toLocaleString('es-CO')}`, 14, 30);

      doc.autoTable({
        startY: 40,
        head: [['Métrica', 'Valor']],
        body: [
          ['Ganancia Bruta (Ventas)', COP(summary.grossSales)],
          ['Costo de Mercancía Vendida', COP(-summary.costOfGoods)],
          ['Otros Egresos (Flujo de Caja)', COP(-summary.otherExpenses)],
          [{ content: 'Ganancia Neta', styles: { fontStyle: 'bold' } }, { content: COP(summary.netProfit), styles: { fontStyle: 'bold' } }],
        ],
        theme: 'grid',
        headStyles: { fillColor: [0, 114, 255] }
      });

      if (sales.length > 0) {
        doc.autoTable({
          startY: doc.autoTable.previous.finalY + 10,
          head: [['Fecha', 'Producto', 'Cant.', 'Total Venta']],
          body: sales.map(s => {
            const p = window.appState.products.find(p => p.id === s.productId);
            return [fmtDate(s.fecha), p?.nombre || 'N/A', s.unidades, COP(s.totalVenta)];
          }),
          theme: 'striped',
          headStyles: { fillColor: [48, 49, 52] }
        });
      }

      if (expenses.length > 0) {
        doc.autoTable({
          startY: doc.autoTable.previous.finalY + 10,
          head: [['Fecha', 'Descripción Egreso', 'Monto']],
          body: expenses.map(e => [fmtDate(e.date), e.description, COP(e.amount)]),
          theme: 'striped',
          headStyles: { fillColor: [48, 49, 52] }
        });
      }

      doc.save(`Reporte_${new Date().toISOString().slice(0,10)}.pdf`);
    }catch(err){
      console.error(err);
      alert('No se pudo generar el PDF: ' + (err && err.message ? err.message : err));
    }
  }

  document.addEventListener('click', function(e){
    if(e.target && e.target.id === 'export-pdf-btn'){
      generatePDF();
    }
  });
})();
</script>
</body>
</html>
